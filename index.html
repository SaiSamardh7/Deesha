<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Deesha ‚Äî Trip Setup</title>

<style>
  :root{
    --brandA:#123f8c;
    --brandB:#1e5bb8;
    --muted:#6b7a8a;
    --shadow: 0 18px 46px rgba(0,0,0,.14);
    --cardShadow: 0 18px 34px rgba(0,0,0,.10);
    --stroke: rgba(185,205,230,.9);
  }

  *{ box-sizing:border-box; }
  html, body { height:100%; }

  body{
    margin:0;
    min-height:100vh;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: clamp(12px, 3vw, 28px);
    background: radial-gradient(1200px 700px at 50% 35%, rgba(210,240,255,0.95), #f6fbff 60%, #f6fbff);
  }

  /* Outer container */
  .shell{
    width: min(980px, 95vw);
    padding: clamp(20px, 3.4vw, 36px);
    border-radius: 28px;
    background: linear-gradient(180deg, rgba(210,240,255,0.75), rgba(255,255,255,0.55));
    box-shadow: var(--shadow);
    border: 1px solid rgba(160, 200, 235, 0.35);

    display:flex;
    align-items:center;
    justify-content:center;

    height: auto;
    min-height: unset;
    overflow: visible;

    transition: width 0.6s ease, padding 0.6s ease, box-shadow 0.6s ease, background 0.6s ease;
  }

  /* Stage 2/3/4 layout */
  .shell.stage2,
  .shell.stage3,
  .shell.stage4{
    width: min(1280px, 96vw);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    gap: 28px;
    padding: clamp(16px, 2.6vw, 24px);
  }

  /* Left card */
  .card{
    width: 640px;
    flex: 0 0 auto;
    border-radius: 26px;
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(190, 215, 240, 0.75);
    box-shadow: var(--cardShadow);
    padding: 26px;
    transition: width 0.6s ease, transform 0.6s ease;
  }

  .shell.stage2 .card,
  .shell.stage3 .card{
    width: 600px;
    align-self: flex-start;
  }

  /* In Stage 4, hide the whole left card (we go full map + itinerary) */
  .shell.stage4 .card{ display:none; }

  .header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom: 18px;
  }

  .logoBox{
    width:46px;height:46px;
    border-radius:14px;
    background:#fff;
    border:1px solid rgba(190,215,240,.9);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex: 0 0 auto;
  }

  .logoBox img{
    width:34px;height:34px;
    object-fit:contain;
    display:block;
  }

  .brand{
    font-size:32px;
    font-weight:900;
    color:var(--brandA);
    line-height: 1.05;
  }

  .stage{
    font-size:14px;
    font-weight:700;
    color:var(--muted);
    margin-top: 2px;
  }

  .inner{
    margin-top:10px;
    border-radius:22px;
    background:rgba(255,255,255,.96);
    border:1px solid rgba(190,215,240,.75);
    padding:22px;
  }

  .row{
    display:grid;
    grid-template-columns: 170px 1fr;
    gap:14px;
    padding:12px 0;
    align-items:center;
  }

  .label{
    font-size:20px;
    font-weight:800;
    color:#7a8a9a;
  }

  input, select{
    height:50px;
    width:100%;
    border-radius:18px;
    border:1px solid var(--stroke);
    padding:10px 14px;
    font-size:17px;
    outline:none;
    min-width: 0;
    background:#fff;
    color:#0b1220;
  }

  input:focus, select:focus{
    border-color: rgba(30, 91, 184, 0.65);
    box-shadow: 0 0 0 5px rgba(30, 91, 184, 0.12);
  }

/* Autocomplete dropdown */
.acWrap{ position:relative; width:100%; }
.acList{
  position:absolute;
  top: calc(50px + 8px);
  left:0; right:0;
  z-index: 50;
  background:#fff;
  border:1px solid rgba(185,205,230,.9);
  border-radius:16px;
  box-shadow: 0 18px 34px rgba(0,0,0,.10);
  overflow:hidden;
  display:none;
  max-height: 260px;
  overflow:auto;
}
.acList.show{ display:block; }
.acItem{
  padding:12px 14px;
  cursor:pointer;
  font-weight:800;
  color:#0b1220;
  border-bottom:1px solid rgba(185,205,230,.45);
}
.acItem:last-child{ border-bottom:0; }
.acItem:hover{ background: rgba(207,239,255,.55); }
.acHint{
  margin-top:6px;
  font-size:12px;
  font-weight:800;
  color: rgba(11,18,32,.55);
  padding-left: 6px;
}

  /* Counter */
  .counter{
    width: 150px;
    height: 40px;
    border-radius: 14px;
    display:grid;
    grid-template-columns:40px 1fr 40px;
    overflow:hidden;
    border:1px solid var(--stroke);
    background:#fff;
  }
  .counter button{
    border:0;
    font-size:18px;
    font-weight:900;
    color:var(--brandA);
    background:rgba(207,239,255,.75);
    cursor:pointer;
  }
  .counter button:hover{ background: rgba(207,239,255,0.95); }
  .counter .mid{
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:16px;
    color:#0b1220;
    background:#fff;
  }

  /* Mini headings for Adults/Kids */
  .groupBlock{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:150px;
  }
  .groupMiniLabel{
    font-size:13px;
    font-weight:900;
    color:#7a8a9a;
    padding-left:6px;
  }

  /* Group size pill (Stage 3 summary) */
  .groupPill{
    display:inline-flex;
    align-items:center;
    height:50px;
    padding:0 16px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:#fff;
    font-weight:900;
    color:#0b1220;
    width: fit-content;
  }

  /* Continue */
  .cta{
    height:54px;
    padding:0 18px;
    border-radius:18px;
    border:0;
    font-size:18px;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
    box-shadow:0 14px 22px rgba(18,63,140,.22);
    width: 100%;
    margin-top: 18px;
  }
  .cta:hover{ filter: brightness(1.03); }
  .cta:active{ transform: translateY(1px); }

  /* Hide Continue when Stage 2 or 3 is open */
  .shell.stage2 #continueBtn,
  .shell.stage3 #continueBtn{ display:none; }

  /* Stage 2 panel */
  .stage2-panel{
    flex: 0 0 auto;
    display: none;
    opacity: 0;
    transform: translateX(18px);
    pointer-events: none;
    transition: opacity 0.35s ease, transform 0.6s ease;
  }
  .shell.stage2 .stage2-panel{
    display: block;
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
    width: 420px;
  }
  .shell.stage3 .stage2-panel{ display:none; }

  /* Right panel card */
  .panelCard{
    border-radius:26px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:26px;
  }

  .panelTitle{
    font-size:22px;
    font-weight:900;
    color:var(--brandA);
    margin:0 0 12px;
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
  }

  .chip{
    padding:12px 14px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:#fff;
    cursor:pointer;
    user-select:none;
    display:inline-flex;
    align-items:baseline;
    gap:8px;
    color:#0b1220;
    transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease;
    white-space: nowrap;
  }

  .chip:hover{ background: rgba(207,239,255,.60); transform: translateY(-1px); }

  .chipMain{
    font-weight:900;
    font-size:16px;
    color:#0b1220;
  }

  .chipSub{
    font-weight:700;
    font-size:13px;
    color: rgba(11,18,32,0.62);
  }

  .chip.on{
    background: rgba(207,239,255,.95);
    border-color: rgba(30,91,184,.55);
  }

  /* Actions */
  .panelActions{
    margin-top:18px;
    display:flex;
    justify-content:flex-end;
    gap:12px;
    align-items:center;
  }

  .panelNext{
    height:54px;
    padding:0 18px;
    border-radius:18px;
    border:0;
    font-size:18px;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
    box-shadow:0 14px 22px rgba(18,63,140,.22);
    min-width: 160px;
  }

  /* Stage 3 panel */
  .stage3-panel{
    flex:0 0 auto;
    display:none;
    opacity:0;
    transform:translateX(18px);
    pointer-events:none;
    transition:opacity .35s ease, transform .6s ease;
  }
  .shell.stage3 .stage3-panel{
    display:block;
    opacity:1;
    transform:translateX(0);
    pointer-events:auto;
    width:420px;
  }

  .constraint{ margin-bottom:16px; }
  .constraintLabel{
    font-weight:900;
    color:var(--brandA);
    margin-bottom:8px;
  }
  .seg{ display:flex; gap:8px; }
  .seg button{
    flex:1;
    padding:10px 0;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:#fff;
    font-weight:900;
    cursor:pointer;
  }
  .seg button.on{
    background:rgba(207,239,255,.95);
    border-color:rgba(30,91,184,.55);
  }

  /* Stage 3 left-card: group pill + selected preferences */
  .groupRowSummary{ display:none; }
  .prefSummaryWrap{ display:none; margin-top: 14px; }

  .shell.stage3 .groupRowEdit{ display:none; }
  .shell.stage3 .groupRowSummary{ display:grid; }
  .shell.stage3 .prefSummaryWrap{ display:block; }

  /* Selected preferences (Stage 3) ‚Äî compact + expandable */
  .prefSummaryHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin: 4px 0 10px;
  }

  .prefSummaryTitle{
    font-size:14px;
    font-weight:900;
    color:var(--brandA);
    margin:0;
  }

  .prefToggle{
    border:1px solid var(--stroke);
    background:#fff;
    color:var(--brandA);
    font-weight:900;
    border-radius:999px;
    padding:8px 12px;
    cursor:pointer;
    font-size:13px;
    line-height:1;
  }
  .prefToggle:hover{
    background: rgba(207,239,255,.55);
  }

  /* Collapsed: show up to ~2 lines */
  .prefSummary{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    max-height: 104px;
    overflow:hidden;
  }

  /* Expanded: scrollable area to keep card stable */
  .prefSummary.expanded{
    max-height: 220px;
    overflow:auto;
    padding-right: 6px;
  }

  .prefSummary.expanded::-webkit-scrollbar{ width: 8px; }
  .prefSummary.expanded::-webkit-scrollbar-thumb{
    background: rgba(185,205,230,.9);
    border-radius: 999px;
  }
  .prefSummary.expanded::-webkit-scrollbar-track{
    background: rgba(207,239,255,.35);
    border-radius: 999px;
  }

  /* summary chips: keep the look but not clickable */
  .prefSummary .chip{
    cursor:default;
    pointer-events:none;
  }
  .prefSummary .chip:hover{
    background:#fff;
    transform:none;
  }

  /* ------------------ Stage 4 (MAP + ITINERARY) ------------------ */
  .stage4-panel{
    flex: 1 1 auto;
    display:none;
    opacity:0;
    transform:translateY(10px);
    pointer-events:none;
    transition:opacity .35s ease, transform .6s ease;
    width: 100%;
  }
  .shell.stage4 .stage4-panel{
    display:block;
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
  }
  /* Stage 4:x push branding (logo + name) down */
.shell.stage4 .stage4Top{ 
  margin-top: 60px;
}
.shell.stage4 .itineraryCard{
  margin-top: -60px; /* try -10 to -40 */
}

/* Stage 4: keep map close to branding */
.shell.stage4 .mapCard{
  margin-top: 2px;
}

  .shell.stage4 .stage2-panel,
  .shell.stage4 .stage3-panel{ display:none; }

  .stage4Top{
    display:flex;
    align-items:center;
    gap:14px;
    margin-bottom: 14px;
    padding: 6px 4px;
  }
  
  .stage4Brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .stage4Brand .brand{ font-size:30px; }
  .stage4Brand .stage{ margin:60px; }

  .stage4Grid{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap: 8px;
    align-items:start;
    width: 100%;
  }

  .mapCard{
    border-radius:26px;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:18px;
    min-height: 640px;
  }
  /* Stage 4: push the map box down (keep header/logo at top, right panel unchanged) */
.shell.stage4 .mapCard{ margin-top: 2px; }

  .mapMock{
    height: 100%;
    min-height: 604px;
    border-radius: 22px;
    border:1px solid rgba(190,215,240,.75);
    background:
      radial-gradient(900px 500px at 30% 30%, rgba(207,239,255,.75), rgba(255,255,255,.35)),
      linear-gradient(180deg, rgba(240,250,255,.95), rgba(255,255,255,.75));
    position: relative;
    overflow:hidden;
  }

  .mapMockTopBar{
    position:absolute;
    top:100px;
    left:14px;
    right:14px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    pointer-events:none;
  }
  /* Real Google Map layer inside Stage 4 */
    #mapCanvas{
      position:absolute;
      inset:0;
      border-radius: 22px;
      overflow:hidden;
      z-index: 1;
    }
    .mapMockTopBar{ z-index: 3; }
    .mapLegend{ z-index: 3; }
    #mockRouteLine{ z-index: 2; position:absolute; inset:0; }

  .mapPill{
    pointer-events:none;
    display:inline-flex;
    gap:10px;
    align-items:center;
    padding:10px 14px;
    border-radius: 999px;
    border:1px solid rgba(190,215,240,.85);
    background: rgba(255,255,255,.88);
    box-shadow: 0 10px 18px rgba(0,0,0,.08);
    font-weight:900;
    color: var(--brandA);
    font-size: 13px;
  }

  .routeLine{
    position:absolute;
    inset: 0;
    opacity: .9;
  }

  .mapLegend{
    position:absolute;
    bottom:14px;
    left:14px;
    display:flex;
    gap:10px;
    align-items:center;
  }

  .legendDot{
    width:30px;height:30px;
    border-radius: 999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    color:#fff;
    box-shadow: 0 10px 18px rgba(0,0,0,.14);
  }

  .legendA{ background: var(--brandA); }
  .legendB{ background: #f59e0b; }
  .legendC{ background: #22c55e; }

  .itineraryCard{
    border-radius:26px;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:26px;
  }

  .itinTitle{
    font-size:22px;
    font-weight:900;
    color:var(--brandA);
    margin:0 0 14px;
  }

  .itinList{ display:flex; flex-direction:column; gap:12px; }

  .stopRow{
    border-radius:18px;
    border:1px solid rgba(190,215,240,.75);
    background:#fff;
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .stopLeft{ display:flex; align-items:center; gap:12px; min-width:0; }

  .stopBadge{
    width:34px;height:34px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    color:#fff;
    flex: 0 0 auto;
  }

  .badgeA{ background: var(--brandA); }
  .badgeB{ background: #f59e0b; }
  .badgeC{ background: #22c55e; }

  .stopText{
    font-weight:900;
    color:#0b1220;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .stopActions{
    display:flex;
    gap:10px;
    align-items:center;
    color: rgba(11,18,32,.55);
    font-weight:900;
  }

  .timeRow{
    display:flex;
    align-items:center;
    gap:10px;
    color: rgba(11,18,32,.65);
    font-weight:800;
    padding-left: 46px;
  }

  .constraintsMini{
    margin-top: 16px;
    border-top:1px solid rgba(190,215,240,.75);
    padding-top: 14px;
  }

  .constraintsMiniTitle{
    font-weight:900;
    color: var(--brandA);
    margin: 0 0 10px;
  }

  .miniRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:7px 0;
    font-weight:800;
    color: rgba(11,18,32,.78);
  }

  .miniVal{ font-weight:900; color: rgba(11,18,32,.9); }

  .optBtn{
    margin-top: 16px;
    width: 100%;
    height: 54px;
    border-radius: 18px;
    border:0;
    font-size:18px;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
    box-shadow:0 14px 22px rgba(18,63,140,.22);
  }
  .optBtn:hover{ filter: brightness(1.03); }

  @media (max-width: 1100px){
    .stage4Grid{ grid-template-columns: 1fr; }
    .mapCard{ min-height: 460px; }
    .mapMock{ min-height: 420px; }
  }

  @media (max-width: 860px){
    .shell.stage2, .shell.stage3{ flex-direction: column; align-items: center; }
    .shell.stage2 .card, .shell.stage3 .card{ width: 100%; }
    .shell.stage2 .stage2-panel, .shell.stage3 .stage3-panel{ width: 100%; }
    .row{ grid-template-columns: 1fr; }
    .counter{ width: 100%; }
    .groupBlock{ min-width: 0; }
  }
</style>
</head>

<body>
  <div class="shell" id="shell">

    <!-- Left card -->
    <div class="card">
      <div class="header">
        <div class="logoBox">
          <!-- FIX: repo has logo.png -->
          <img src="assets/logo.jpg" alt="Deesha logo">
        </div>
        <div>
          <div class="brand">Deesha</div>
          <div class="stage">Plan your perfect trip</div>
        </div>
      </div>

      <div class="inner">
        <div class="row">
          <div class="label">Start</div>
          <div class="acWrap">
            <input id="start" placeholder="e.g., dallas, tx" value="Dallas" autocomplete="off">
            <div class="acList" id="startAcList" role="listbox" aria-label="Start suggestions"></div>
            <div class="acHint" id="startHint">Pick a suggestion for best results</div>
          </div>
        </div>

        <div class="row">
          <div class="label">Destination</div>
          <div class="acWrap">
            <input id="dest" placeholder="e.g., austin, tx" value="austin" autocomplete="off">
            <div class="acList" id="destAcList" role="listbox" aria-label="Destination suggestions"></div>
            <div class="acHint" id="destHint">Pick a suggestion for best results</div>
          </div>
        </div>

        <div class="row">
          <div class="label">Travel Mode</div>
          <select id="mode">
            <option value="Car" selected>Car</option>
            <option value="Flight + car">Flight + car</option>
          </select>
        </div>

        <div class="row">
          <div class="label">Number of Days</div>
          <div class="counter" aria-label="Number of days">
            <button type="button" id="minus">‚àí</button>
            <div class="mid" id="days">1</div>
            <button type="button" id="plus">+</button>
          </div>
        </div>

        <!-- Group size (edit in Stage 1/2) -->
        <div class="row groupRowEdit">
          <div class="label">Group size</div>

          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div class="groupBlock">
              <div class="groupMiniLabel">Adults</div>
              <div class="counter" aria-label="Adults">
                <button type="button" id="adultsMinus">‚àí</button>
                <div class="mid" id="adultsCount">1</div>
                <button type="button" id="adultsPlus">+</button>
              </div>
            </div>

            <div class="groupBlock">
              <div class="groupMiniLabel">Kids</div>
              <div class="counter" aria-label="Kids">
                <button type="button" id="kidsMinus">‚àí</button>
                <div class="mid" id="kidsCount">0</div>
                <button type="button" id="kidsPlus">+</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Group size (summary pill in Stage 3) -->
        <div class="row groupRowSummary">
          <div class="label">Group size</div>
          <div class="groupPill" id="groupPill">Adults 1, Kids 0</div>
        </div>

        <!-- Selected preferences summary (Stage 3 only) -->
        <div class="prefSummaryWrap" id="prefSummaryWrap">
          <div class="prefSummaryHeader">
            <div class="prefSummaryTitle">Selected preferences</div>
            <button type="button" class="prefToggle" id="prefToggle" aria-expanded="false">Show all</button>
          </div>
          <div class="prefSummary" id="selectedPrefs"></div>
        </div>

        <button class="cta" id="continueBtn" type="button">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Stage 2: Preferences -->
    <div class="stage2-panel" id="stage2Panel" aria-hidden="true">
      <div class="panelCard">
        <div class="panelTitle">Preferences</div>

        <div class="chips" id="chips">
          <div class="chip" data-key="adventure"><span class="chipMain">Adventure</span> <span class="chipSub">(zipline/ATV/rafting)</span></div>
          <div class="chip" data-key="hiking"><span class="chipMain">Hiking</span> <span class="chipSub">(easy/moderate/hard)</span></div>
          <div class="chip" data-key="scenic"><span class="chipMain">Scenic views</span> <span class="chipSub">(sunrise/sunset)</span></div>
          <div class="chip" data-key="hidden"><span class="chipMain">Hidden gems</span> <span class="chipSub">(offbeat)</span></div>
          <div class="chip" data-key="food"><span class="chipMain">Food</span> <span class="chipSub">(must-try/cafes)</span></div>
          <div class="chip" data-key="nature"><span class="chipMain">Nature</span> <span class="chipSub">(lakes/waterfalls/deserts)</span></div>
          <div class="chip" data-key="photo"><span class="chipMain">Photography spots</span></div>
          <div class="chip" data-key="nightlife"><span class="chipMain">Nightlife / events</span></div>
          <div class="chip" data-key="relax"><span class="chipMain">Relax</span> <span class="chipSub">(spas/beaches)</span></div>
        </div>

        <div class="panelActions">
          <button class="panelNext" id="nextBtn" type="button">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Stage 3: Constraints -->
    <div class="stage3-panel" id="stage3Panel" aria-hidden="true">
      <div class="panelCard">
        <div class="panelTitle">Constraints</div>

        <div class="constraint">
          <div class="constraintLabel">Budget</div>
          <div class="seg" data-key="budget">
            <button data-val="low">LOW</button>
            <button data-val="mid" class="on">MID</button>
            <button data-val="high">HIGH</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Fitness level (for hikes)</div>
          <div class="seg" data-key="fitness">
            <button data-val="easy" class="on">EASY</button>
            <button data-val="moderate">MODERATE</button>
            <button data-val="hard">HARD</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Food preference</div>
          <div class="seg" data-key="foodPref">
            <button data-val="halal">HALAL</button>
            <button data-val="veg" class="on">VEG</button>
            <button data-val="nonveg">NON-VEG</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Alcohol</div>
          <div class="seg" data-key="alcohol">
            <button data-val="no" class="on">NO</button>
            <button data-val="yes">YES</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Tolls</div>
          <div class="seg" data-key="tolls">
            <button data-val="avoid" class="on">AVOID</button>
            <button data-val="add">ADD</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Adventure level</div>
          <div class="seg" data-key="adventureLevel">
            <button data-val="chill">CHILL</button>
            <button data-val="balanced" class="on">BALANCED</button>
            <button data-val="extreme">EXTREME</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Pet friendly</div>
          <div class="seg" data-key="petFriendly">
            <button data-val="yes">YES</button>
            <button data-val="no" class="on">NO</button>
          </div>
        </div>

        <div class="panelActions">
          <button class="panelNext" id="buildBtn" type="button">Build itinerary ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Stage 4: Map + Itinerary -->
    <div class="stage4-panel" id="stage4Panel" aria-hidden="true">
      <div style="width:100%;">
        <div class="stage4Top">
          <div class="stage4Brand">
            <div class="logoBox" style="width:42px;height:42px;">
              <img src="assets/logo.jpg" alt="Deesha logo">
            </div>
            <div>
              <div class="brand">Deesha</div>
            </div>
          </div>
        </div>

        <div class="stage4Grid">
          <!-- MAP (75% area) -->
          <div class="mapCard">
            <div class="mapMock" id="mapMock" aria-label="Map preview">
              <div class="mapMockTopBar">
                <div class="mapPill" id="mapPillText">Route preview</div>
                <div class="mapPill">Edit stops in itinerary ‚Üí</div>
              </div>

              <div id="mapCanvas" aria-hidden="false"></div>

              <!-- Fallback mock route (hidden when Google Map is ready) -->
              <svg class="routeLine" id="mockRouteLine" viewBox="0 0 1000 700" preserveAspectRatio="none" aria-hidden="true">
                <path d="M 230 170 C 340 230, 390 280, 480 360 S 650 520, 760 560" fill="none" stroke="rgba(18,63,140,.9)" stroke-width="10" stroke-linecap="round"/>
                <path d="M 230 170 C 340 230, 390 280, 480 360 S 650 520, 760 560" fill="none" stroke="rgba(255,255,255,.85)" stroke-width="4" stroke-linecap="round"/>
              </svg>

              <div class="mapLegend">
                <div class="legendDot legendA">A</div>
                <div class="legendDot legendB">B</div>
                <div class="legendDot legendC">C</div>
              </div>
            </div>
          </div>

          <!-- ITINERARY PANEL -->
          <div class="itineraryCard">
            <div class="itinTitle">Itinerary</div>

            <div class="itinList">
              <div class="stopRow">
                <div class="stopLeft">
                  <div class="stopBadge badgeA">A</div>
                  <div class="stopText" id="itinA">Start</div>
                </div>
                <div class="stopActions">‚â°</div>
              </div>

              <div class="timeRow" id="timeAB">üöó 1 hr 35 min</div>

              <div class="stopRow" id="stopBRow">
                <div class="stopLeft">
                  <div class="stopBadge badgeB">B</div>
                  <div style="min-width:0;">
                    <div class="stopText" id="itinB">Stop (optional)</div>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:6px; color: rgba(11,18,32,.65); font-weight:800;">
                      ‚è± <span id="stayB">1 hr</span> <span id="stayBLabel">at a spot</span>
                    </div>
                  </div>
                </div>
                <div class="stopActions">
                  <button type="button" id="replaceB" title="Replace stop" style="border:0;background:transparent;cursor:pointer;font-size:16px;">üîÅ</button>
                  <button type="button" id="deleteB" title="Remove stop" style="border:0;background:transparent;cursor:pointer;font-size:16px;">üóë</button>
                </div>
              </div>

              <div class="timeRow" id="timeBC">üöó 1 hr 25 min</div>

              <div class="stopRow">
                <div class="stopLeft">
                  <div class="stopBadge badgeC">C</div>
                  <div class="stopText" id="itinC">Destination</div>
                </div>
                <div class="stopActions">‚â°</div>
              </div>
            </div>

            <div class="constraintsMini">
              <div class="constraintsMiniTitle">Constraints</div>
              <div class="miniRow"><span>Budget</span><span class="miniVal" id="cBudget">MID</span></div>
              <div class="miniRow"><span>Fitness level</span><span class="miniVal" id="cFitness">MODERATE</span></div>
              <div class="miniRow"><span>Food preference</span><span class="miniVal" id="cFood">VEG</span></div>
              <div class="miniRow"><span>Alcohol</span><span class="miniVal" id="cAlcohol">NO</span></div>
              <div class="miniRow"><span>Tolls</span><span class="miniVal" id="cTolls">AVOID</span></div>
              <div class="miniRow"><span>Adventure</span><span class="miniVal" id="cAdventure">BALANCED</span></div>
              <div class="miniRow"><span>Pet friendly</span><span class="miniVal" id="cPet">NO</span></div>
            </div>

            <button class="optBtn" id="optimizeBtn" type="button">Optimize Trip ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- load palette.js -->
  <script src="assets/palette.js"></script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7B9a5IMfFeaWfIksdUskfoX7TbMJBbVk&libraries=geometry&callback=onGoogleMapsLoaded">
</script>

<script>
  // --- Days ---
  const daysEl = document.getElementById("days");
  document.getElementById("minus").onclick = () => {
    daysEl.textContent = Math.max(1, +daysEl.textContent - 1);
  };
  document.getElementById("plus").onclick = () => {
    daysEl.textContent = Math.min(30, +daysEl.textContent + 1);
  };

  // --- Group size ---
  const adultsEl = document.getElementById("adultsCount");
  const kidsEl = document.getElementById("kidsCount");

  document.getElementById("adultsMinus").onclick = () => {
    adultsEl.textContent = Math.max(1, +adultsEl.textContent - 1);
  };
  document.getElementById("adultsPlus").onclick = () => {
    adultsEl.textContent = Math.min(20, +adultsEl.textContent + 1);
  };

  document.getElementById("kidsMinus").onclick = () => {
    kidsEl.textContent = Math.max(0, +kidsEl.textContent - 1);
  };
  document.getElementById("kidsPlus").onclick = () => {
    kidsEl.textContent = Math.min(20, +kidsEl.textContent + 1);
  };

  // --- Chip toggles (Stage 2) ---
  document.getElementById("chips").addEventListener("click", (e) => {
    const chip = e.target.closest(".chip");
    if (!chip) return;
    chip.classList.toggle("on");
  });

  // --- Stage control ---
  const shell = document.getElementById("shell");
  const stage2Panel = document.getElementById("stage2Panel");
  const stage3Panel = document.getElementById("stage3Panel");
  const stage4Panel = document.getElementById("stage4Panel");
  const startEl = document.getElementById("start");
  const destEl  = document.getElementById("dest");

  // --- Stage 4: Google Map state ---
let gMap = null;
let gPolyline = null;
let gMarkers = [];

// --- Stage 4: Optional middle stop (B) coords ---
let stopBLat = null;
let stopBLng = null;
let stopBPlaceId = null;

function clearMapOverlays(){
  if (gPolyline){ gPolyline.setMap(null); gPolyline = null; }
  gMarkers.forEach(m => { try{ m.setMap(null); }catch(_){ } });
  gMarkers = [];
}

function ensureMapReady(){
  const canvas = document.getElementById("mapCanvas");
  const mock = document.getElementById("mockRouteLine");

  if (!window.google || !google.maps || !canvas) {
    if (mock) mock.style.display = "block";
    return false;
  }

  if (!gMap){
    gMap = new google.maps.Map(canvas, {
      center: { lat: 39.5, lng: -98.35 },
      zoom: 4,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
    });
  }

  if (mock) mock.style.display = "none";
  return true;
}

window.onGoogleMapsLoaded = function () {
  // Create the map as soon as Google Maps finishes loading
  ensureMapReady();

  // If Stage 4 is already open, try drawing the route now
  if (shell.classList.contains("stage4")) {
    updateStage4Route();
  }
};

// Decode encoded polyline (Google encoded polyline algorithm)
function decodePolyline(encoded){
  let index = 0, lat = 0, lng = 0;
  const coordinates = [];

  while (index < encoded.length){
    let b, shift = 0, result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lat += dlat;

    shift = 0;
    result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lng += dlng;

    coordinates.push({ lat: lat / 1e5, lng: lng / 1e5 });
  }

  return coordinates;
}

async function fetchRouteFromBackend(payload){
  const res = await fetch("http://127.0.0.1:8000/routes", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok){
    const txt = await res.text();
    throw new Error(txt || `HTTP ${res.status}`);
  }
  return await res.json();
}

function renderRouteOnMap(route){
  if (!ensureMapReady()) return;
  clearMapOverlays();

  const path = route?.polyline ? decodePolyline(route.polyline) : null;
  if (!path || path.length < 2){
    console.warn("No polyline to draw:", route);
    return;
  }

  gPolyline = new google.maps.Polyline({
    path,
    geodesic: true,
    strokeOpacity: 0.9,
    strokeWeight: 6,
    map: gMap,
  });

  const a = path[0];
  const c = path[path.length - 1];
  gMarkers.push(new google.maps.Marker({ position: a, map: gMap, label: "A" }));
  gMarkers.push(new google.maps.Marker({ position: c, map: gMap, label: "C" }));

  if (stopBLat != null && stopBLng != null) {
    const bPos = { lat: stopBLat, lng: stopBLng };
    gMarkers.push(new google.maps.Marker({ position: bPos, map: gMap, label: "B" }));
  }

  const bounds = new google.maps.LatLngBounds();
  path.forEach(p => bounds.extend(p));

  // Include B in the viewport if present
  if (stopBLat != null && stopBLng != null) {
    bounds.extend({ lat: stopBLat, lng: stopBLng });
  }

  gMap.fitBounds(bounds);
}

async function updateStage4Route(){
  if (startLat == null || startLng == null || destinationLat == null || destinationLng == null){
    console.warn("Missing lat/lng for route", { startLat, startLng, destinationLat, destinationLng });
    return;
  }

  const payload = {
    start: { lat: startLat, lng: startLng, place_id: startPlaceId || null },
    destination: { lat: destinationLat, lng: destinationLng, place_id: destinationPlaceId || null },
  };

  // If the user has a middle stop (B), send it as a waypoint so backend can route A -> B -> C
  if (stopBLat != null && stopBLng != null) {
    payload.waypoints = [
      { lat: stopBLat, lng: stopBLng, place_id: stopBPlaceId || null }
    ];
  }

  try{
    const route = await fetchRouteFromBackend(payload);
    renderRouteOnMap(route);

    const dur = route.duration_text || route.duration || null;
    const dist = route.distance_text || route.distance || null;

    const pill = document.getElementById("mapPillText");
    if (pill){
      pill.textContent = dist && dur ? `${dist} ‚Ä¢ ${dur}` : (dur || "Route preview");
    }

    const timeAB = document.getElementById("timeAB");
    const timeBC = document.getElementById("timeBC");
    if (timeAB && dur) timeAB.textContent = `üöó ${dur}`;
    if (timeBC) timeBC.style.display = "none";
  }catch(e){
    console.warn("/routes not ready yet:", e);
    const mock = document.getElementById("mockRouteLine");
    if (mock) mock.style.display = "block";
  }
}

  // --- Autocomplete state ---
const startAcList = document.getElementById("startAcList");
const destAcList  = document.getElementById("destAcList");

let startSelected = null; // { description, place_id, types }
let destSelected  = null; // { description, place_id, types }

function showList(listEl, items, onPick){
  listEl.innerHTML = "";
  if (!items || items.length === 0){
    listEl.classList.remove("show");
    return;
  }
  items.slice(0, 8).forEach((p) => {
    const div = document.createElement("div");
    div.className = "acItem";
    div.textContent = p.description || "";
    div.addEventListener("mousedown", (e) => {
      e.preventDefault(); // so blur doesn't kill click
      onPick(p);
    });
    listEl.appendChild(div);
  });
  listEl.classList.add("show");
}

function hideList(listEl){
  listEl.classList.remove("show");
}

async function fetchAutocomplete(query){
  // We want "recommendations" without using the Google Places JS Autocomplete widget.
  // So we call our backend and render the custom dropdown.

  // 1) Try GET with `input=` (current)
  const getUrl1 = `http://127.0.0.1:8000/places/autocomplete?input=${encodeURIComponent(query)}&components=country:us`;
  try{
    const res = await fetch(getUrl1, { method: "GET" });
    if (res.ok) return await res.json();
    const txt = await res.text().catch(() => "");
    console.warn("Autocomplete GET (input=) failed", res.status, txt);
  }catch(e){
    console.warn("Autocomplete GET (input=) network error:", e);
  }

  // 2) Try GET with `text=` (some backends name it this way)
  const getUrl2 = `http://127.0.0.1:8000/places/autocomplete?text=${encodeURIComponent(query)}&components=country:us`;
  try{
    const res = await fetch(getUrl2, { method: "GET" });
    if (res.ok) return await res.json();
    const txt = await res.text().catch(() => "");
    console.warn("Autocomplete GET (text=) failed", res.status, txt);
  }catch(e){
    console.warn("Autocomplete GET (text=) network error:", e);
  }

  // 3) Try POST (send BOTH `input` and `text` for maximum compatibility)
  try{
    const res = await fetch("http://127.0.0.1:8000/places/autocomplete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input: query, text: query, components: "country:us" })
    });
    if (res.ok) return await res.json();
    const txt = await res.text().catch(() => "");
    console.warn("Autocomplete POST failed", res.status, txt);
  }catch(e){
    console.warn("Autocomplete POST network error:", e);
  }

  // 4) Last resort: fall back to /places/resolve and convert to a single-item "predictions" array.
  // This gives *some* recommendation behavior even if autocomplete endpoint is missing.
  try{
    const res = await fetch("http://127.0.0.1:8000/places/resolve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: query })
    });
    if (!res.ok){
      const txt = await res.text().catch(() => "");
      throw new Error(`Resolve fallback failed ${res.status}: ${txt}`);
    }
    const data = await res.json();
    const place = data.place || {};
    if (place.place_id){
      return {
        predictions: [{
          description: place.formatted_address || place.name || query,
          place_id: place.place_id
        }]
      };
    }
  }catch(e){
    console.warn("Autocomplete fallback via /places/resolve failed:", e);
  }

  // Nothing worked
  return { predictions: [] };
}

async function fetchDetails(placeId){
  const getUrl = `http://127.0.0.1:8000/places/details?place_id=${encodeURIComponent(placeId)}`;
  try{
    const res = await fetch(getUrl, { method: "GET" });
    if (res.ok) return await res.json();

    let errTxt = "";
    try{ errTxt = await res.text(); }catch(_){ }
    console.warn("Details GET failed", res.status, errTxt);
  }catch(e){
    console.warn("Details GET network error:", e);
  }

  const postUrl = "http://127.0.0.1:8000/places/details";
  const res2 = await fetch(postUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ place_id: placeId })
  });
  if (!res2.ok){
    const txt = await res2.text().catch(() => "");
    throw new Error(`Details failed. ${res2.status}. ${txt}`);
  }
  return await res2.json();
}

function wireAutocomplete(inputEl, listEl, onPicked){
  let t = null;

  inputEl.addEventListener("input", () => {
    clearTimeout(t);
    const q = inputEl.value.trim();

    // typing invalidates previous selection
    onPicked(null, true);

    if (q.length < 2){
      hideList(listEl);
      return;
    }

    t = setTimeout(async () => {
      try{
        const data = await fetchAutocomplete(q);
        // Debug: inspect the raw payload that feeds the suggestions
        // console.log("AC payload:", data);
        showList(listEl, data.predictions || [], (pred) => {
          inputEl.value = pred.description || inputEl.value;
          hideList(listEl);
          onPicked(pred, false);
        });
      }catch(e){
        hideList(listEl);
        console.warn("Autocomplete error:", e);
        // Optional: show a quick hint so you know it's a backend/cors issue
        const hintId = (inputEl.id === "start") ? "startHint" : (inputEl.id === "dest") ? "destHint" : null;
        const hintEl = hintId ? document.getElementById(hintId) : null;
        if (hintEl){
          hintEl.textContent = "Autocomplete not available (check backend /places/autocomplete)";
          setTimeout(() => { hintEl.textContent = "Pick a suggestion for best results"; }, 2500);
        }
      }
    }, 250);
  });

  inputEl.addEventListener("focus", () => {
    const q = inputEl.value.trim();
    if (q.length >= 2) inputEl.dispatchEvent(new Event("input"));
  });

  inputEl.addEventListener("blur", () => {
    setTimeout(() => hideList(listEl), 120);
  });
}

// Wire autocomplete for Start & Destination (Stage 1)
wireAutocomplete(startEl, startAcList, async (pred, typed) => {
  if (typed) {
    startSelected = null;
    startPlaceId = startLat = startLng = null;
    return;
  }
  startSelected = pred;
  startPlaceId = pred?.place_id || null;
  startLat = startLng = null;

  if (startPlaceId){
    try{
      const d = await fetchDetails(startPlaceId);
      startLat = (typeof d.lat === "number") ? d.lat : null;
      startLng = (typeof d.lng === "number") ? d.lng : null;
    }catch(e){
      console.warn("Start details error:", e);
    }
  }
});

wireAutocomplete(destEl, destAcList, async (pred, typed) => {
  if (typed) {
    destSelected = null;
    destinationPlaceId = destinationLat = destinationLng = null;
    return;
  }
  destSelected = pred;
  destinationPlaceId = pred?.place_id || null;
  destinationLat = destinationLng = null;

  if (destinationPlaceId){
    try{
      const d = await fetchDetails(destinationPlaceId);
      destinationLat = (typeof d.lat === "number") ? d.lat : null;
      destinationLng = (typeof d.lng === "number") ? d.lng : null;
    }catch(e){
      console.warn("Destination details error:", e);
    }
  }

  // update palette as soon as user picks a destination
  updateThemeFromDestination();
});

  // ----------------------------
  // Google Places (Option A): resolve destination via backend (key stays on server)
  // ----------------------------
  let destinationPlaceId = null;
  let destinationLat = null;
  let destinationLng = null;

  let startPlaceId = null;
  let startLat = null;
  let startLng = null;

  async function resolveDestinationViaBackend() {
    const destinationText = destEl.value.trim();
    if (!destinationText) {
      alert("Please enter a destination.");
      destEl.focus();
      return false;
    }

    try {
      const res = await fetch("http://127.0.0.1:8000/places/resolve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: destinationText })
      });

      if (!res.ok) {
        let msg = `Places resolve failed (HTTP ${res.status})`;
        try {
          const err = await res.json();
          if (err && err.detail) msg = String(err.detail);
        } catch (_) {}
        alert(msg);
        return false;
      }

      const data = await res.json();
      const place = data.place || {};
      destinationPlaceId = place.place_id || null;
      destinationLat = (typeof place.lat === "number") ? place.lat : null;
      destinationLng = (typeof place.lng === "number") ? place.lng : null;

      console.log("‚úÖ Destination resolved via backend:", data);
      return true;
    } catch (e) {
      alert("Backend error while resolving destination: " + (e?.message || e));
      return false;
    }
  }

  async function resolveStartViaBackend() {
    const startText = startEl.value.trim();
    if (!startText) {
      alert("Please enter a start location.");
      startEl.focus();
      return false;
    }

    try {
      const res = await fetch("http://127.0.0.1:8000/places/resolve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: startText })
      });

      if (!res.ok) {
        let msg = `Start resolve failed (HTTP ${res.status})`;
        try {
          const err = await res.json();
          if (err && err.detail) msg = String(err.detail);
        } catch (_) {}
        alert(msg);
        return false;
      }

      const data = await res.json();
      const place = data.place || {};
      startPlaceId = place.place_id || null;
      startLat = (typeof place.lat === "number") ? place.lat : null;
      startLng = (typeof place.lng === "number") ? place.lng : null;
      console.log("‚úÖ Start resolved via backend:", data);
      return true;
    } catch (e) {
      alert("Backend error while resolving start: " + (e?.message || e));
      return false;
    }
  }

  // Always start Stage 1
  shell.classList.remove("stage2","stage3","stage4");
  stage2Panel.setAttribute("aria-hidden", "true");
  stage3Panel.setAttribute("aria-hidden", "true");
  stage4Panel.setAttribute("aria-hidden", "true");

  // ----------------------------
  // Theme from destination state (palette.js)
  // ----------------------------
  const STATE_ABBR = {
    AL:"Alabama", AK:"Alaska", AZ:"Arizona", AR:"Arkansas", CA:"California", CO:"Colorado", CT:"Connecticut",
    DE:"Delaware", FL:"Florida", GA:"Georgia", HI:"Hawaii", ID:"Idaho", IL:"Illinois", IN:"Indiana", IA:"Iowa",
    KS:"Kansas", KY:"Kentucky", LA:"Louisiana", ME:"Maine", MD:"Maryland", MA:"Massachusetts", MI:"Michigan",
    MN:"Minnesota", MS:"Mississippi", MO:"Missouri", MT:"Montana", NE:"Nebraska", NV:"Nevada", NH:"New Hampshire",
    NJ:"New Jersey", NM:"New Mexico", NY:"New York", NC:"North Carolina", ND:"North Dakota", OH:"Ohio", OK:"Oklahoma",
    OR:"Oregon", PA:"Pennsylvania", RI:"Rhode Island", SC:"South Carolina", SD:"South Dakota", TN:"Tennessee",
    TX:"Texas", UT:"Utah", VT:"Vermont", VA:"Virginia", WA:"Washington", WV:"West Virginia", WI:"Wisconsin", WY:"Wyoming"
  };

  function normalizeStateFromLocation(input) {
    const raw = (input || "").trim();
    if (!raw) return null;

    const parts = raw.split(",").map(s => s.trim()).filter(Boolean);
    const last = (parts[parts.length - 1] || "").trim();
    if (!last) return null;

    const abbr = last.toUpperCase();
    if (STATE_ABBR[abbr]) return STATE_ABBR[abbr];

    try {
      const keys = (typeof STATE_THEMES !== "undefined" && STATE_THEMES) ? Object.keys(STATE_THEMES) : [];
      const match = keys.find(k => k.toLowerCase() === last.toLowerCase());
      return match || null;
    } catch {
      return null;
    }
  }

  function updateThemeFromDestination() {
    const stateName = normalizeStateFromLocation(destEl.value);
    if (stateName && typeof applyStateTheme === "function") {
      applyStateTheme(stateName);
    }
  }

  // Live destination typing (debounced)
  destEl.addEventListener("input", () => {
    clearTimeout(window.__themeT);
    window.__themeT = setTimeout(updateThemeFromDestination, 200);
  });

  // --- Stage 1 -> Stage 2 ---
  document.getElementById("continueBtn").addEventListener("click", async () => {
    const start = startEl.value.trim();
    const dest = destEl.value.trim();

    if (!start || !dest) {
      alert("Please enter both Start and Destination.");
      if (!start) startEl.focus();
      else destEl.focus();
      return;
    }

    // Resolve start + destination with Google Places via backend (Option A)
    // If the user picked an autocomplete suggestion, we already have place_id (and usually lat/lng).
    // Only fall back to /places/resolve when missing.

    let okStart = true;
    if (!startPlaceId || startLat == null || startLng == null) {
      okStart = await resolveStartViaBackend();
    }
    if (!okStart) return;

    let okDest = true;
    if (!destinationPlaceId || destinationLat == null || destinationLng == null) {
      okDest = await resolveDestinationViaBackend();
    }
    if (!okDest) return;

    console.log("Start:", { startPlaceId, startLat, startLng, startText: startEl.value.trim() });
    console.log("Destination:", { destinationPlaceId, destinationLat, destinationLng, destText: destEl.value.trim() });
    updateThemeFromDestination();
    hideList(startAcList);
    hideList(destAcList);

    shell.classList.add("stage2");
    stage2Panel.setAttribute("aria-hidden", "false");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // --- Stage 2 -> Stage 3 ---
  document.getElementById("nextBtn").addEventListener("click", () => {
    updateThemeFromDestination();

    // group pill
    document.getElementById("groupPill").textContent =
      `Adults ${+adultsEl.textContent}, Kids ${+kidsEl.textContent}`;

    // selected preferences summary
    const selectedPrefsEl = document.getElementById("selectedPrefs");
    selectedPrefsEl.innerHTML = "";
    const selected = Array.from(document.querySelectorAll("#chips .chip.on"));
    selected.forEach(chip => selectedPrefsEl.appendChild(chip.cloneNode(true)));

    // collapse prefs list by default
    const prefToggle = document.getElementById("prefToggle");
    selectedPrefsEl.classList.remove("expanded");
    prefToggle.textContent = "Show all";
    prefToggle.setAttribute("aria-expanded", "false");
    prefToggle.style.display = (selected.length > 6) ? "inline-flex" : "none";

    shell.classList.remove("stage2");
    shell.classList.add("stage3");
    stage2Panel.setAttribute("aria-hidden", "true");
    stage3Panel.setAttribute("aria-hidden", "false");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // Stage 3 preferences: expand/collapse
  document.getElementById("prefToggle").addEventListener("click", () => {
    const list = document.getElementById("selectedPrefs");
    const toggle = document.getElementById("prefToggle");
    const expanded = list.classList.toggle("expanded");
    toggle.textContent = expanded ? "Show less" : "Show all";
    toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
  });

  // Segmented switch behavior (Stage 3 constraints)
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".seg button");
    if (!btn) return;

    const seg = btn.parentElement;
    seg.querySelectorAll("button").forEach(b => b.classList.remove("on"));
    btn.classList.add("on");
  });

  // --- Stage 3 -> Stage 4 (Build itinerary) ---
document.getElementById("buildBtn").addEventListener("click", async () => {
  // 1) constraints
  const constraints = {};
  document.querySelectorAll(".seg").forEach(seg => {
    const key = seg.dataset.key;
    const active = seg.querySelector("button.on");
    constraints[key] = active ? active.dataset.val : null;
  });

  // 2) interests from chips
  const interests = Array.from(document.querySelectorAll("#chips .chip.on")).map(c => {
    const k = c.dataset.key;
    if (k === "photo") return "photography";
    if (k === "hidden") return "hidden gems";
    return k;
  });

  // 3) build backend payload
  const backendPayload = {
    start_city: startEl.value.trim(),
    destination: destEl.value.trim(),
    destination_state: normalizeStateFromLocation(destEl.value) || "Texas",

    // Start Places (resolved in Stage 1)
    start_place_id: startPlaceId,
    start_lat: startLat,
    start_lng: startLng,

    // Places (resolved in Stage 1)
    destination_place_id: destinationPlaceId,
    destination_lat: destinationLat,
    destination_lng: destinationLng,

    days: +daysEl.textContent,
    pace: constraints.adventureLevel || "balanced",
    group: { adults: +adultsEl.textContent, kids: +kidsEl.textContent },
    interests
  };

  // 4) call backend (smallest possible)
  let data;
  try {
    const res = await fetch("http://127.0.0.1:8000/plan-trip", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(backendPayload)
    });

    // Only continue if we got 200 OK
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(txt || `HTTP ${res.status}`);
    }

    data = await res.json();
    console.log("Backend response:", data);
    alert(data.summary || "Trip planned! Check console for details.");
  } catch (e) {
    alert("Backend error: " + e.message);
    return; // stop here (no stage switching)
  }

  // 5) Render Stage 4 using response
  document.getElementById("itinA").textContent = data.start_city || "Start";
  document.getElementById("itinC").textContent = data.destination || "Destination";
  document.getElementById("mapPillText").textContent = `${data.start_city} ‚Üí ${data.destination}`;

  // middle stop (B)
  document.getElementById("itinB").textContent = data.days?.[0]?.stops?.[1]?.title || "Stop (optional)";

  // üîë IMPORTANT: resolve B to lat/lng so route can go A ‚Üí B ‚Üí C
const bTitle = data.days?.[0]?.stops?.[1]?.title;

if (bTitle) {
  try {
    const resB = await fetch("http://127.0.0.1:8000/places/resolve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: bTitle })
    });

    if (resB.ok) {
      const rb = await resB.json();
      const p = rb.place || {};
      stopBLat = (typeof p.lat === "number") ? p.lat : null;
      stopBLng = (typeof p.lng === "number") ? p.lng : null;
      stopBPlaceId = p.place_id || null;
    }
  } catch (e) {
    console.warn("Failed to resolve B stop:", e);
  }
}

  // 6) Constraints mini summary
  const up = (v) => (v ? String(v).toUpperCase() : "‚Äî");
  document.getElementById("cBudget").textContent    = up(constraints.budget);
  document.getElementById("cFitness").textContent   = up(constraints.fitness);
  document.getElementById("cFood").textContent      = up(constraints.foodPref);
  document.getElementById("cAlcohol").textContent   = up(constraints.alcohol);
  document.getElementById("cTolls").textContent     = up(constraints.tolls);
  document.getElementById("cAdventure").textContent = up(constraints.adventureLevel);
  document.getElementById("cPet").textContent       = up(constraints.petFriendly);

  // 7) Finally: move to Stage 4 after success
  shell.classList.remove("stage2", "stage3");
  shell.classList.add("stage4");
  stage2Panel.setAttribute("aria-hidden", "true");
  stage3Panel.setAttribute("aria-hidden", "true");
  stage4Panel.setAttribute("aria-hidden", "false");
  window.scrollTo({ top: 0, behavior: "smooth" });
  updateStage4Route();
});



  // --- Stop B actions ---
const replaceBBtn = document.getElementById("replaceB");
const deleteBBtn = document.getElementById("deleteB");

if (deleteBBtn){
  deleteBBtn.addEventListener("click", () => {
    document.getElementById("itinB").textContent = "Stop (optional)";
    const timeBC = document.getElementById("timeBC");
    if (timeBC) timeBC.style.display = "none";
    stopBLat = stopBLng = null;
    stopBPlaceId = null;
    updateStage4Route();
  });
}

if (replaceBBtn){
  replaceBBtn.addEventListener("click", async () => {
    const interests = Array.from(document.querySelectorAll("#chips .chip.on")).map(c => c.dataset.key);

    try{
      const res = await fetch("http://127.0.0.1:8000/places/alternatives", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          start: { lat: startLat, lng: startLng, place_id: startPlaceId || null },
          destination: { lat: destinationLat, lng: destinationLng, place_id: destinationPlaceId || null },
          interests,
        })
      });

      if (!res.ok){
        const txt = await res.text();
        throw new Error(txt || `HTTP ${res.status}`);
      }

      const alt = await res.json();
      document.getElementById("itinB").textContent = alt.title || alt.name || "New stop";
      document.getElementById("stayB").textContent = alt.stay || "1 hr";

      stopBLat = (typeof alt.lat === "number") ? alt.lat : null;
      stopBLng = (typeof alt.lng === "number") ? alt.lng : null;
      stopBPlaceId = alt.place_id || null;

updateStage4Route(); // redraw route + marker
    }catch(e){
      alert("Replace stop not ready yet (backend endpoint missing): " + (e?.message || e));
    }
  });
}

// Stage 4 button placeholder
document.getElementById("optimizeBtn").addEventListener("click", () => {
  alert("Optimize Trip ‚Üí coming next (real route + stop suggestions)");
});



  // Apply theme on load if destination already includes state
  updateThemeFromDestination();
</script>

</body>
</html>
