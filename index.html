<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Deesha ‚Äî Trip Setup</title>

<style>
  :root{
    --brandA:#123f8c;
    --brandB:#1e5bb8;
    --muted:#6b7a8a;
    --shadow: 0 18px 46px rgba(0,0,0,.14);
    --cardShadow: 0 18px 34px rgba(0,0,0,.10);
    --stroke: rgba(185,205,230,.9);
  }

  *{ box-sizing:border-box; }
  html, body { height:100%; }

  body{
    margin:0;
    min-height:100vh;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: clamp(12px, 3vw, 28px);
    background: radial-gradient(1200px 700px at 50% 35%, rgba(210,240,255,0.95), #f6fbff 60%, #f6fbff);
  }

  /* Outer container */
  .shell{
    width: min(980px, 95vw);
    padding: clamp(20px, 3.4vw, 36px);
    border-radius: 28px;
    background: linear-gradient(180deg, rgba(210,240,255,0.75), rgba(255,255,255,0.55));
    box-shadow: var(--shadow);
    border: 1px solid rgba(160, 200, 235, 0.35);

    display:flex;
    align-items:center;
    justify-content:center;

    height: auto;
    min-height: unset;
    overflow: visible;

    transition: width 0.6s ease, padding 0.6s ease, box-shadow 0.6s ease, background 0.6s ease;
  }

  /* Stage 2/3/3.5/4 layout */
  .shell.stage2,
  .shell.stage3,
  .shell.stage35,
  .shell.stage4{
    width: min(1280px, 96vw);
    display:flex;
    align-items:flex-start;
    justify-content:center;
    gap: 28px;
    padding: clamp(16px, 2.6vw, 24px);
  }

  /* Left card */
  .card{
    width: 640px;
    flex: 0 0 auto;
    border-radius: 26px;
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(190, 215, 240, 0.75);
    box-shadow: var(--cardShadow);
    padding: 26px;
    transition: width 0.6s ease, transform 0.6s ease;
  }

  .shell.stage2 .card,
  .shell.stage3 .card,
  .shell.stage35 .card{
    width: 600px;
    align-self: flex-start;
  }

  /* In Stage 3.5, hide the left card (we use a full-width recommendations layout) */
  .shell.stage35 .card{ display:none; }
  /* ------------------ Stage 3.5 (RECOMMENDATIONS) ------------------ */
  .stage35-panel{
    flex: 1 1 auto;
    display:none;
    opacity:0;
    transform:translateY(10px);
    pointer-events:none;
    transition:opacity .35s ease, transform .6s ease;
    width: 100%;
  }
  .shell.stage35 .stage35-panel{
    display:block;
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
  }
  .shell.stage35 .stage2-panel,
  .shell.stage35 .stage3-panel{ display:none; }

  .stage35Top{
    display:flex;
    align-items:center;
    gap:40px;
    margin-bottom: 0px;
    padding: 6px 4px;
  }

  .stage35Grid{
    display:grid;
    grid-template-columns: 360px 1fr;
    gap: 18px;
    align-items:stretch;
    width:100%;
  }

  .moodCard{
    border-radius:26px;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:24px 22px 26px;
    position:sticky;
    top: 10px;
    display:flex;
    flex-direction:column;
  }
  .moodTitle{
    font-size:26px;
    font-weight:900;
    color:#0b1220;
    margin:0 0 6px;
  }
  .moodSub{
    font-size:14px;
    font-weight:800;
    color: rgba(11,18,32,.62);
    margin:0 0 14px;
  }
  .moodList{
    display:flex;
    flex-direction:column;
    gap:12px;
    margin-top: 12px;
    flex:1 1 auto;
  }
  .moodBtn{
    width:100%;
    border-radius:18px;
    border:1px solid rgba(185,205,230,.9);
    background:#fff;
    padding:14px 14px;
    display:flex;
    align-items:center;
    gap:12px;
    cursor:pointer;
    font-weight:900;
    color:#0b1220;
    font-size:18px;
    transition: transform .06s ease, background .15s ease, border-color .15s ease;
  }
  .moodBtn:hover{ background: rgba(207,239,255,.55); transform: translateY(-1px); }
  .moodBtn.on{ background: rgba(207,239,255,.95); border-color: rgba(30,91,184,.55); }
  .moodIcon{ width:36px; height:36px; display:flex; align-items:center; justify-content:center; font-size:26px; }

  .scrollFab{
    margin-top:14px;
    width:54px;
    height:54px;
    border-radius:999px;
    border:1px solid rgba(185,205,230,.9);
    background: rgba(255,255,255,.92);
    box-shadow: 0 14px 22px rgba(18,63,140,.12);
    cursor:pointer;
    font-weight:900;
    color: var(--brandA);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
  }
  .scrollFab:hover{ background: rgba(207,239,255,.75); }

  .recWrap{
    border-radius:26px;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:22px;
  }

  .recHeader{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:12px;
    margin-bottom: 12px;
  }
  .recHeader h2{
    margin:0;
    font-size:28px;
    font-weight:900;
    color:#0b1220;
  }
  .recHint{
    font-size:13px;
    font-weight:900;
    color: rgba(11,18,32,.62);
  }

  .recScroll{
    max-height: 640px;
    overflow:auto;
    padding-right: 6px;
  }
  .recScroll::-webkit-scrollbar{ width: 8px; }
  .recScroll::-webkit-scrollbar-thumb{ background: rgba(185,205,230,.9); border-radius: 999px; }
  .recScroll::-webkit-scrollbar-track{ background: rgba(207,239,255,.35); border-radius: 999px; }

  .recGrid{
    display:grid;
    grid-template-columns: repeat(2, minmax(280px, 1fr));
    gap:16px;
  }

  .recCard{
    border-radius:22px;
    border:1px solid rgba(185,205,230,.9);
    background:#fff;
    padding:14px;
    box-shadow: 0 12px 20px rgba(0,0,0,.06);
    overflow:hidden;
  }
  .recTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
  .recName{ font-weight:900; font-size:18px; margin:0; color:#0b1220; }
  .recTag{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(185,205,230,.9);
    background: rgba(207,239,255,.35);
    font-weight:900;
    font-size:13px;
    color: rgba(11,18,32,.78);
    white-space:nowrap;
  }
  .recImgs{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
  .recImg{
    height:120px;
    border-radius:16px;
    border:1px solid rgba(185,205,230,.6);
    background:
      radial-gradient(900px 500px at 30% 30%, rgba(207,239,255,.75), rgba(255,255,255,.35)),
      linear-gradient(180deg, rgba(240,250,255,.95), rgba(255,255,255,.75));
  }
  .recDesc{ margin-top:10px; font-weight:800; color: rgba(11,18,32,.72); }
  .recMetaRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; }
  .recMeta{ font-weight:900; color: rgba(11,18,32,.72); font-size:13px; }
  .recBtn{
    height:40px;
    padding:0 14px;
    border-radius:12px;
    border:0;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
  }
  .recBtn.added{ background: rgba(34,197,94,.9); }

  .stage35Actions{
    margin-top:30px;
    padding-top:4px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
  }
  .ghostBtn{
    height:54px;
    padding:0 18px;
    border-radius:18px;
    border:1px solid var(--stroke);
    background:#fff;
    font-size:18px;
    font-weight:900;
    color: var(--brandA);
    cursor:pointer;
  }
  .ghostBtn:hover{ background: rgba(207,239,255,.35); }

  @media (max-width: 1100px){
    .stage35Grid{ grid-template-columns: 1fr; }
    .moodCard{ position:relative; top:auto; }
    .recGrid{ grid-template-columns: 1fr; }
  }

  /* In Stage 4, hide the whole left card (we go full map + itinerary) */
  .shell.stage4 .card{ display:none; }

  .header{
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom: 18px;
  }

  .logoBox{
    width:46px;height:46px;
    border-radius:14px;
    background:#fff;
    border:1px solid rgba(190,215,240,.9);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex: 0 0 auto;
  }

  .logoBox img{
    width:34px;height:34px;
    object-fit:contain;
    display:block;
  }

  .brand{
    font-size:32px;
    font-weight:900;
    color:var(--brandA);
    line-height: 1.05;
  }

  .stage{
    font-size:14px;
    font-weight:700;
    color:var(--muted);
    margin-top: 2px;
  }

  .inner{
    margin-top:10px;
    border-radius:22px;
    background:rgba(255,255,255,.96);
    border:1px solid rgba(190,215,240,.75);
    padding:22px;
  }

  .row{
    display:grid;
    grid-template-columns: 170px 1fr;
    gap:14px;
    padding:12px 0;
    align-items:center;
  }

  .label{
    font-size:20px;
    font-weight:800;
    color:#7a8a9a;
  }

  input, select{
    height:50px;
    width:100%;
    border-radius:18px;
    border:1px solid var(--stroke);
    padding:10px 14px;
    font-size:17px;
    outline:none;
    min-width: 0;
    background:#fff;
    color:#0b1220;
  }

  input:focus, select:focus{
    border-color: rgba(30, 91, 184, 0.65);
    box-shadow: 0 0 0 5px rgba(30, 91, 184, 0.12);
  }

/* Autocomplete dropdown */
.acWrap{ position:relative; width:100%; }
.acList{
  position:absolute;
  top: calc(50px + 8px);
  left:0; right:0;
  z-index: 50;
  background:#fff;
  border:1px solid rgba(185,205,230,.9);
  border-radius:16px;
  box-shadow: 0 18px 34px rgba(0,0,0,.10);
  overflow:hidden;
  display:none;
  max-height: 260px;
  overflow:auto;
}
.acList.show{ display:block; }
.acItem{
  padding:12px 14px;
  cursor:pointer;
  font-weight:800;
  color:#0b1220;
  border-bottom:1px solid rgba(185,205,230,.45);
}
.acItem:last-child{ border-bottom:0; }
.acItem:hover{ background: rgba(207,239,255,.55); }
.acHint{
  margin-top:6px;
  font-size:12px;
  font-weight:800;
  color: rgba(11,18,32,.55);
  padding-left: 6px;
}

  /* Counter */
  .counter{
    width: 150px;
    height: 40px;
    border-radius: 14px;
    display:grid;
    grid-template-columns:40px 1fr 40px;
    overflow:hidden;
    border:1px solid var(--stroke);
    background:#fff;
  }
  .counter button{
    border:0;
    font-size:18px;
    font-weight:900;
    color:var(--brandA);
    background:rgba(207,239,255,.75);
    cursor:pointer;
  }
  .counter button:hover{ background: rgba(207,239,255,0.95); }
  .counter .mid{
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:16px;
    color:#0b1220;
    background:#fff;
  }

  /* Mini headings for Adults/Kids */
  .groupBlock{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:150px;
  }
  .groupMiniLabel{
    font-size:13px;
    font-weight:900;
    color:#7a8a9a;
    padding-left:6px;
  }

  /* Group size pill (Stage 3 summary) */
  .groupPill{
    display:inline-flex;
    align-items:center;
    height:50px;
    padding:0 16px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:#fff;
    font-weight:900;
    color:#0b1220;
    width: fit-content;
  }

  /* Continue */
  .cta{
    height:54px;
    padding:0 18px;
    border-radius:18px;
    border:0;
    font-size:18px;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
    box-shadow:0 14px 22px rgba(18,63,140,.22);
    width: 100%;
    margin-top: 18px;
  }
  .cta:hover{ filter: brightness(1.03); }
  .cta:active{ transform: translateY(1px); }

  /* Hide Continue when Stage 2 or 3 is open */
  .shell.stage2 #continueBtn,
  .shell.stage3 #continueBtn{ display:none; }

  /* Stage 2 panel */
  .stage2-panel{
    flex: 0 0 auto;
    display: none;
    opacity: 0;
    transform: translateX(18px);
    pointer-events: none;
    transition: opacity 0.35s ease, transform 0.6s ease;
  }
  .shell.stage2 .stage2-panel{
    display: block;
    opacity: 1;
    transform: translateX(0);
    pointer-events: auto;
    width: 420px;
  }
  .shell.stage3 .stage2-panel{ display:none; }

  /* Right panel card */
  .panelCard{
    border-radius:26px;
    background:rgba(255,255,255,.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:26px;
  }

  .panelTitle{
    font-size:22px;
    font-weight:900;
    color:var(--brandA);
    margin:0 0 12px;
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
  }

  .chip{
    padding:12px 14px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:#fff;
    cursor:pointer;
    user-select:none;
    display:inline-flex;
    align-items:baseline;
    gap:8px;
    color:#0b1220;
    transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease;
    white-space: nowrap;
  }

  .chip:hover{ background: rgba(207,239,255,.60); transform: translateY(-1px); }

  .chipMain{
    font-weight:900;
    font-size:16px;
    color:#0b1220;
  }

  .chipSub{
    font-weight:700;
    font-size:13px;
    color: rgba(11,18,32,0.62);
  }

  .chip.on{
    background: rgba(207,239,255,.95);
    border-color: rgba(30,91,184,.55);
  }

  /* Actions */
  .panelActions{
    margin-top:18px;
    display:flex;
    justify-content:flex-end;
    gap:12px;
    align-items:center;
  }

  .panelNext{
    height:54px;
    padding:0 18px;
    border-radius:18px;
    border:0;
    font-size:18px;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
    box-shadow:0 14px 22px rgba(18,63,140,.22);
    min-width: 160px;
  }

  /* Stage 3 panel */
  .stage3-panel{
    flex:0 0 auto;
    display:none;
    opacity:0;
    transform:translateX(18px);
    pointer-events:none;
    transition:opacity .35s ease, transform .6s ease;
  }
  .shell.stage3 .stage3-panel{
    display:block;
    opacity:1;
    transform:translateX(0);
    pointer-events:auto;
    width:420px;
  }

  .constraint{ margin-bottom:16px; }
  .constraintLabel{
    font-weight:900;
    color:var(--brandA);
    margin-bottom:8px;
  }
  .seg{ display:flex; gap:8px; }
  .seg button{
    flex:1;
    padding:10px 0;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:#fff;
    font-weight:900;
    cursor:pointer;
  }
  .seg button.on{
    background:rgba(207,239,255,.95);
    border-color:rgba(30,91,184,.55);
  }

  /* Stage 3 left-card: group pill + selected preferences */
  .groupRowSummary{ display:none; }
  .prefSummaryWrap{ display:none; margin-top: 14px; }

  .shell.stage3 .groupRowEdit{ display:none; }
  .shell.stage3 .groupRowSummary{ display:grid; }
  .shell.stage3 .prefSummaryWrap{ display:block; }

  /* Selected preferences (Stage 3) ‚Äî compact + expandable */
  .prefSummaryHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin: 4px 0 10px;
  }

  .prefSummaryTitle{
    font-size:14px;
    font-weight:900;
    color:var(--brandA);
    margin:0;
  }

  .prefToggle{
    border:1px solid var(--stroke);
    background:#fff;
    color:var(--brandA);
    font-weight:900;
    border-radius:999px;
    padding:8px 12px;
    cursor:pointer;
    font-size:13px;
    line-height:1;
  }
  .prefToggle:hover{
    background: rgba(207,239,255,.55);
  }

  /* Collapsed: show up to ~2 lines */
  .prefSummary{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    max-height: 104px;
    overflow:hidden;
  }

  /* Expanded: scrollable area to keep card stable */
  .prefSummary.expanded{
    max-height: 220px;
    overflow:auto;
    padding-right: 6px;
  }

  .prefSummary.expanded::-webkit-scrollbar{ width: 8px; }
  .prefSummary.expanded::-webkit-scrollbar-thumb{
    background: rgba(185,205,230,.9);
    border-radius: 999px;
  }
  .prefSummary.expanded::-webkit-scrollbar-track{
    background: rgba(207,239,255,.35);
    border-radius: 999px;
  }

  /* summary chips: keep the look but not clickable */
  .prefSummary .chip{
    cursor:default;
    pointer-events:none;
  }
  .prefSummary .chip:hover{
    background:#fff;
    transform:none;
  }

  /* ------------------ Stage 4 (MAP + ITINERARY) ------------------ */
  .stage4-panel{
    flex: 1 1 auto;
    display:none;
    opacity:0;
    transform:translateY(10px);
    pointer-events:none;
    transition:opacity .35s ease, transform .6s ease;
    width: 100%;
  }
  .shell.stage4 .stage4-panel{
    display:block;
    opacity:1;
    transform:translateY(0);
    pointer-events:auto;
  }

  .shell.stage4 .stage2-panel,
  .shell.stage4 .stage3-panel{ display:none; }

  .stage4Top{
    display:flex;
    align-items:center;
    gap:14px;
    margin-bottom: 14px;
    padding: 6px 4px;
  }
  
  .stage4Brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .stage4Brand .brand{ font-size:30px; }
  .stage4Brand .stage{ margin:60px; }

  .stage4Grid{
    display:grid;
    grid-template-columns: 1fr 420px;
    gap: 8px;
    align-items:start;
    width: 100%;
  }

  .mapCard{
    border-radius:26px;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:18px;
    min-height: 680px;
  }
  .stage4Bottom{
    margin-top: 0;
    position: relative;
    top: 0px; /* pull the Back button further up to reduce the gap */
    display:flex;
    justify-content:flex-start;
  }

  .stage4Bottom .ghostBtn{
    margin-left: 0;
  }

  .mapMock{
    height: 100%;
    min-height: 650px;
    border-radius: 22px;
    border:1px solid rgba(190,215,240,.75);
    background:
      radial-gradient(900px 500px at 30% 30%, rgba(207,239,255,.75), rgba(255,255,255,.35)),
      linear-gradient(180deg, rgba(240,250,255,.95), rgba(255,255,255,.75));
    position: relative;
    overflow:hidden;
  }

  .mapMockTopBar{
    position:absolute;
    top:100px;
    left:14px;
    right:14px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    pointer-events:none;
  }
  /* Real Google Map layer inside Stage 4 */
    #mapCanvas{
      position:absolute;
      inset:0;
      border-radius: 22px;
      overflow:hidden;
      z-index: 1;
    }
    .mapMockTopBar{ z-index: 3; }
    .mapLegend{ z-index: 3; }
    #mockRouteLine{ z-index: 2; position:absolute; inset:0; }

  .mapPill{
    pointer-events:none;
    display:inline-flex;
    gap:10px;
    align-items:center;
    padding:10px 14px;
    border-radius: 999px;
    border:1px solid rgba(190,215,240,.85);
    background: rgba(255,255,255,.88);
    box-shadow: 0 10px 18px rgba(0,0,0,.08);
    font-weight:900;
    color: var(--brandA);
    font-size: 13px;
  }

  .routeLine{
    position:absolute;
    inset: 0;
    opacity: .9;
  }

  .mapLegend{
    position:absolute;
    bottom:14px;
    left:14px;
    display:flex;
    gap:10px;
    align-items:center;
  }

  .legendDot{
    width:30px;height:30px;
    border-radius: 999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    color:#fff;
    box-shadow: 0 10px 18px rgba(0,0,0,.14);
  }

  .legendA{ background: var(--brandA); }
  .legendB{ background: #f59e0b; }
  .legendC{ background: #22c55e; }

  .itineraryCard{
    border-radius:26px;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(190,215,240,.75);
    box-shadow:var(--cardShadow);
    padding:26px;

    /* Prevent page glitching: keep the right panel height stable and scroll its contents */
    display:flex;
    flex-direction:column;
    height: 680px;          /* fixed height so the card doesn't grow */
    overflow: hidden;       /* keep scrolling inside .itinScroll */
  }

  .itinScroll{
    flex: 1 1 auto;
    min-height: 0;          /* IMPORTANT: enables scrolling inside a flex column */
    overflow:auto;
    padding-right: 6px;
  }
  .itinScroll::-webkit-scrollbar{ width: 8px; }
  .itinScroll::-webkit-scrollbar-thumb{ background: rgba(185,205,230,.9); border-radius: 999px; }
  .itinScroll::-webkit-scrollbar-track{ background: rgba(207,239,255,.35); border-radius: 999px; }

  .itinTitle{
    font-size:22px;
    font-weight:900;
    color:var(--brandA);
    margin:0 0 14px;
  }

  .itinList{ display:flex; flex-direction:column; gap:12px; }

  .stopRow{
    border-radius:18px;
    border:1px solid rgba(190,215,240,.75);
    background:#fff;
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }

  .stopLeft{ display:flex; align-items:center; gap:12px; min-width:0; }

  .stopBadge{
    width:34px;height:34px;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    color:#fff;
    flex: 0 0 auto;
  }

  .badgeA{ background: var(--brandA); }
  .badgeB{ background: #f59e0b; }
  .badgeC{ background: #22c55e; }

  .stopText{
    font-weight:900;
    color:#0b1220;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .stopActions{
    display:flex;
    gap:10px;
    align-items:center;
    color: rgba(11,18,32,.55);
    font-weight:900;
  }

  .timeRow{
    display:flex;
    align-items:center;
    gap:10px;
    color: rgba(11,18,32,.65);
    font-weight:800;
    padding-left: 46px;
  }

  .constraintsMini{
    margin-top: 16px;
    border-top:1px solid rgba(190,215,240,.75);
    padding-top: 14px;
  }

  .constraintsMiniTitle{
    font-weight:900;
    color: var(--brandA);
    margin: 0 0 10px;
  }

  .extraStopsWrap{
    margin-top: 16px;
    border-top: 1px dashed rgba(190,215,240,.75);
    padding-top: 10px;
  }

  .extraStop{
    padding: 4px 0;
    font-weight: 800;
    color: rgba(11,18,32,.78);
    font-size: 14px;
  }

  .miniRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:7px 0;
    font-weight:800;
    color: rgba(11,18,32,.78);
  }

  .miniVal{ font-weight:900; color: rgba(11,18,32,.9); }

  .optBtn{
    margin-top: 16px;
    width: 100%;
    height: 54px;
    border-radius: 18px;
    border:0;
    font-size:18px;
    font-weight:900;
    color:#fff;
    cursor:pointer;
    background:linear-gradient(135deg,var(--brandA),var(--brandB));
    box-shadow:0 14px 22px rgba(18,63,140,.22);
  }
  .optBtn:hover{ filter: brightness(1.03); }

  @media (max-width: 1100px){
    .stage4Grid{ grid-template-columns: 1fr; }
    .mapCard{ min-height: 460px; }
    .mapMock{ min-height: 420px; }
  }

  @media (max-width: 860px){
    .shell.stage2, .shell.stage3{ flex-direction: column; align-items: center; }
    .shell.stage2 .card, .shell.stage3 .card{ width: 100%; }
    .shell.stage2 .stage2-panel, .shell.stage3 .stage3-panel{ width: 100%; }
    .row{ grid-template-columns: 1fr; }
    .counter{ width: 100%; }
    .groupBlock{ min-width: 0; }
  }
</style>
</head>

<body>
  <div class="shell" id="shell">

    <!-- Left card -->
    <div class="card">
      <div class="header">
        <div class="logoBox">
          <!-- FIX: repo has logo.png -->
          <img src="assets/logo.jpg" alt="Deesha logo">
        </div>
        <div>
          <div class="brand">Deesha</div>
          <div class="stage">Plan your perfect trip</div>
        </div>
      </div>

      <div class="inner">
        <div class="row">
          <div class="label">Start</div>
          <div class="acWrap">
            <input id="start" placeholder="e.g., dallas, tx" value="Dallas, TX" autocomplete="off">
            <div class="acList" id="startAcList" role="listbox" aria-label="Start suggestions"></div>
            <div class="acHint" id="startHint">Pick a suggestion for best results</div>
          </div>
        </div>

        <div class="row">
          <div class="label">Destination</div>
          <div class="acWrap">
            <input id="dest" placeholder="e.g., austin, tx" value="Austin, TX" autocomplete="off">
            <div class="acList" id="destAcList" role="listbox" aria-label="Destination suggestions"></div>
            <div class="acHint" id="destHint">Pick a suggestion for best results</div>
          </div>
        </div>

        <div class="row">
          <div class="label">Travel Mode</div>
          <select id="mode">
            <option value="Car" selected>Car</option>
            <option value="Flight + car">Flight + car</option>
          </select>
        </div>

        <div class="row">
          <div class="label">Number of Days</div>
          <div class="counter" aria-label="Number of days">
            <button type="button" id="minus">‚àí</button>
            <div class="mid" id="days">1</div>
            <button type="button" id="plus">+</button>
          </div>
        </div>

        <!-- Group size (edit in Stage 1/2) -->
        <div class="row groupRowEdit">
          <div class="label">Group size</div>

          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div class="groupBlock">
              <div class="groupMiniLabel">Adults</div>
              <div class="counter" aria-label="Adults">
                <button type="button" id="adultsMinus">‚àí</button>
                <div class="mid" id="adultsCount">1</div>
                <button type="button" id="adultsPlus">+</button>
              </div>
            </div>

            <div class="groupBlock">
              <div class="groupMiniLabel">Kids</div>
              <div class="counter" aria-label="Kids">
                <button type="button" id="kidsMinus">‚àí</button>
                <div class="mid" id="kidsCount">0</div>
                <button type="button" id="kidsPlus">+</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Group size (summary pill in Stage 3) -->
        <div class="row groupRowSummary">
          <div class="label">Group size</div>
          <div class="groupPill" id="groupPill">Adults 1, Kids 0</div>
        </div>

        <!-- Selected preferences summary (Stage 3 only) -->
        <div class="prefSummaryWrap" id="prefSummaryWrap">
          <div class="prefSummaryHeader">
            <div class="prefSummaryTitle">Selected preferences</div>
            <button type="button" class="prefToggle" id="prefToggle" aria-expanded="false">Show all</button>
          </div>
          <div class="prefSummary" id="selectedPrefs"></div>
        </div>

        <button class="cta" id="continueBtn" type="button">Continue ‚Üí</button>
      </div>
    </div>

    <!-- Stage 2: Preferences -->
    <div class="stage2-panel" id="stage2Panel" aria-hidden="true">
      <div class="panelCard">
        <div class="panelTitle">Preferences</div>

        <div class="chips" id="chips">
          <div class="chip" data-key="adventure"><span class="chipMain">Adventure</span> <span class="chipSub">(zipline/ATV/rafting)</span></div>
          <div class="chip" data-key="hiking"><span class="chipMain">Hiking</span> <span class="chipSub">(easy/moderate/hard)</span></div>
          <div class="chip" data-key="scenic"><span class="chipMain">Scenic views</span> <span class="chipSub">(sunrise/sunset)</span></div>
          <div class="chip" data-key="hidden"><span class="chipMain">Hidden gems</span> <span class="chipSub">(offbeat)</span></div>
          <div class="chip" data-key="food"><span class="chipMain">Food</span> <span class="chipSub">(must-try/cafes)</span></div>
          <div class="chip" data-key="nature"><span class="chipMain">Nature</span> <span class="chipSub">(lakes/waterfalls/deserts)</span></div>
          <div class="chip" data-key="photo"><span class="chipMain">Photography spots</span></div>
          <div class="chip" data-key="nightlife"><span class="chipMain">Nightlife / events</span></div>
          <div class="chip" data-key="relax"><span class="chipMain">Relax</span> <span class="chipSub">(spas/beaches)</span></div>
        </div>

        <div class="panelActions">
          <button class="panelNext" id="nextBtn" type="button">Next ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Stage 3: Constraints -->
    <div class="stage3-panel" id="stage3Panel" aria-hidden="true">
      <div class="panelCard">
        <div class="panelTitle">Constraints</div>

        <div class="constraint">
          <div class="constraintLabel">Budget</div>
          <div class="seg" data-key="budget">
            <button data-val="low">LOW</button>
            <button data-val="mid" class="on">MID</button>
            <button data-val="high">HIGH</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Fitness level (for hikes)</div>
          <div class="seg" data-key="fitness">
            <button data-val="easy" class="on">EASY</button>
            <button data-val="moderate">MODERATE</button>
            <button data-val="hard">HARD</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Food preference</div>
          <div class="seg" data-key="foodPref">
            <button data-val="halal">HALAL</button>
            <button data-val="veg" class="on">VEG</button>
            <button data-val="nonveg">NON-VEG</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Alcohol</div>
          <div class="seg" data-key="alcohol">
            <button data-val="no" class="on">NO</button>
            <button data-val="yes">YES</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Tolls</div>
          <div class="seg" data-key="tolls">
            <button data-val="avoid" class="on">AVOID</button>
            <button data-val="add">ADD</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Adventure level</div>
          <div class="seg" data-key="adventureLevel">
            <button data-val="chill">CHILL</button>
            <button data-val="balanced" class="on">BALANCED</button>
            <button data-val="extreme">EXTREME</button>
          </div>
        </div>

        <div class="constraint">
          <div class="constraintLabel">Pet friendly</div>
          <div class="seg" data-key="petFriendly">
            <button data-val="yes">YES</button>
            <button data-val="no" class="on">NO</button>
          </div>
        </div>

        <div class="panelActions">
          <button class="panelNext" id="buildBtn" type="button">Build itinerary ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Stage 3.5: Mood + Recommendations -->
    <div class="stage35-panel" id="stage35Panel" aria-hidden="true">
      <div style="width:100%;">
        <div class="stage35Top">
          <div class="header">
            <div class="logoBox">
              <img src="assets/logo.jpg" alt="Deesha logo">
            </div>
            <div>
              <div class="brand">Deesha</div>
            </div>
          </div>
        </div>

        <div class="stage35Grid">
          <!-- LEFT: Mood selection -->
          <div class="moodCard">
            <div class="moodTitle">What are you in the mood for?</div>
            <div class="moodSub">Pick one to see recommendations</div>

            <div class="moodList" id="moodList">
              <button type="button" class="moodBtn on" data-mood="hiking">
                <span class="moodIcon">ü•æ</span>
                <span>Hiking &amp; Nature</span>
              </button>
              <button type="button" class="moodBtn" data-mood="scenic">
                <span class="moodIcon">üåÑ</span>
                <span>Scenic Views</span>
              </button>
              <button type="button" class="moodBtn" data-mood="food">
                <span class="moodIcon">üçΩ</span>
                <span>Food &amp; Caf√©s</span>
              </button>
              <button type="button" class="moodBtn" data-mood="photo">
                <span class="moodIcon">üì∏</span>
                <span>Photography Spots</span>
              </button>
              <button type="button" class="moodBtn" data-mood="culture">
                <span class="moodIcon">üèõ</span>
                <span>Culture &amp; History</span>
              </button>
              <button type="button" class="moodBtn" data-mood="adventure">
                <span class="moodIcon">üõ∂</span>
                <span>Adventure / Activities</span>
              </button>
              <button type="button" class="moodBtn" data-mood="relax">
                <span class="moodIcon">üòå</span>
                <span>Relax &amp; Chill</span>
              </button>
            </div>

            <div class="stage35Actions">
              <button type="button" class="ghostBtn" id="backToStage3">Back</button>
              <button type="button" class="panelNext" id="continueToStage4">Continue ‚Üí</button>
            </div>
          </div>

          <!-- RIGHT: Recommendations -->
          <div class="recWrap">
            <div class="recHeader">
              <h2>Recommended Stops</h2>
              <div class="recHint" id="recHint">Choose one optional stop to add as B</div>
            </div>

            <div class="recScroll" id="recScroll">
              <div class="recGrid" id="recGrid">
                <!-- cards injected by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stage 4: Map + Itinerary -->
    <div class="stage4-panel" id="stage4Panel" aria-hidden="true">
      <div style="width:100%;">
          <div class="stage4Top">
            <div class="stage4Brand">
              <div class="logoBox" style="width:42px;height:42px;">
                <img src="assets/logo.jpg" alt="Deesha logo">
              </div>
              <div>
                <div class="brand">Deesha</div>
              </div>
            </div>
          </div>
        </div>

        <div class="stage4Grid">
          <!-- MAP (75% area) -->
          <div class="mapCard">
            <div class="mapMock" id="mapMock" aria-label="Map preview">
              <div class="mapMockTopBar">
                <div class="mapPill" id="mapPillText">Route preview</div>
                <div class="mapPill">Edit stops in itinerary ‚Üí</div>
              </div>

              <div id="mapCanvas" aria-hidden="false"></div>

              <!-- Fallback mock route (hidden when Google Map is ready) -->
              <svg class="routeLine" id="mockRouteLine" viewBox="0 0 1000 700" preserveAspectRatio="none" aria-hidden="true">
                <path d="M 230 170 C 340 230, 390 280, 480 360 S 650 520, 760 560" fill="none" stroke="rgba(18,63,140,.9)" stroke-width="10" stroke-linecap="round"/>
                <path d="M 230 170 C 340 230, 390 280, 480 360 S 650 520, 760 560" fill="none" stroke="rgba(255,255,255,.85)" stroke-width="4" stroke-linecap="round"/>
              </svg>

              <div class="mapLegend">
                <div class="legendDot legendA">A</div>
                <div class="legendDot legendB">B</div>
                <div class="legendDot legendC">C</div>
              </div>
            </div>
          </div>

          <!-- ITINERARY PANEL -->
          <div class="itineraryCard">
            <div class="itinTitle">Itinerary</div>

            <div class="itinScroll">
              <div class="itinList" id="itinList"></div>

              <!-- other selected recommendations (beyond the first B) -->
              <div id="extraStopsWrap" class="extraStopsWrap" style="display:none;">
                <div class="constraintsMiniTitle">Other planned stops</div>
                <div id="extraStopsList"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="stage4Bottom">
            <button type="button" class="ghostBtn" id="backToStage35From4">‚Üê Back</button>
          </div>
      </div>
    </div>

  </div>

  <!-- load palette.js -->
  <script src="assets/palette.js"></script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB7B9a5IMfFeaWfIksdUskfoX7TbMJBbVk&libraries=geometry&callback=onGoogleMapsLoaded">
</script>

<script>
  // --- Days ---
  const daysEl = document.getElementById("days");
  document.getElementById("minus").onclick = () => {
    daysEl.textContent = Math.max(1, +daysEl.textContent - 1);
  };
  document.getElementById("plus").onclick = () => {
    daysEl.textContent = Math.min(30, +daysEl.textContent + 1);
  };

  // --- Group size ---
  const adultsEl = document.getElementById("adultsCount");
  const kidsEl = document.getElementById("kidsCount");

  document.getElementById("adultsMinus").onclick = () => {
    adultsEl.textContent = Math.max(1, +adultsEl.textContent - 1);
  };
  document.getElementById("adultsPlus").onclick = () => {
    adultsEl.textContent = Math.min(20, +adultsEl.textContent + 1);
  };

  document.getElementById("kidsMinus").onclick = () => {
    kidsEl.textContent = Math.max(0, +kidsEl.textContent - 1);
  };
  document.getElementById("kidsPlus").onclick = () => {
    kidsEl.textContent = Math.min(20, +kidsEl.textContent + 1);
  };

  // --- Chip toggles (Stage 2) ---
  document.getElementById("chips").addEventListener("click", (e) => {
    const chip = e.target.closest(".chip");
    if (!chip) return;
    chip.classList.toggle("on");
  });

  // --- Stage control ---
  const shell = document.getElementById("shell");
  const stage2Panel = document.getElementById("stage2Panel");
  const stage3Panel = document.getElementById("stage3Panel");
  const stage4Panel = document.getElementById("stage4Panel");
  const stage35Panel = document.getElementById("stage35Panel");
  const startEl = document.getElementById("start");
  const destEl  = document.getElementById("dest");
  const API_BASE = "http://127.0.0.1:8000";

  // --- Stage 3.5 state ---
  let stage35BasePayload = null;     // payload assembled from Stage 3
  let stage35Constraints = null;
  let stage35Interests = null;       // chips from Stage 2
  let selectedRec = null;            // chosen B stop
  let selectedRecs = [];             // all selected recommendations (multi-select)
  // Cache the most recent Stage 4 /routes response (includes legs[])
  let lastStage4Route = null;

  const MOOD_TO_INTERESTS = {
    hiking: ["hiking", "nature"],
    scenic: ["scenic views"],
    food: ["food", "cafes"],
    photo: ["photography"],
    culture: ["culture", "history"],
    adventure: ["adventure"],
    relax: ["relax"]
  };

  function esc(s){
    return String(s || "").replace(/[&<>\"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function openStage35(){
    shell.classList.remove("stage2", "stage3", "stage4");
    shell.classList.add("stage35");
    stage2Panel.setAttribute("aria-hidden", "true");
    stage3Panel.setAttribute("aria-hidden", "true");
    stage35Panel.setAttribute("aria-hidden", "false");
    stage4Panel.setAttribute("aria-hidden", "true");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function openStage4(){
    shell.classList.remove("stage2", "stage3", "stage35");
    shell.classList.add("stage4");
    stage2Panel.setAttribute("aria-hidden", "true");
    stage3Panel.setAttribute("aria-hidden", "true");
    stage35Panel.setAttribute("aria-hidden", "true");
    stage4Panel.setAttribute("aria-hidden", "false");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function setMoodActive(mood){
    document.querySelectorAll("#moodList .moodBtn").forEach(b => b.classList.toggle("on", b.dataset.mood === mood));
  }

  async function fetchAlternativeForMood(mood){
    const interests = MOOD_TO_INTERESTS[mood] || [];
    const payload = {
      start: { lat: startLat, lng: startLng, place_id: startPlaceId || null },
      destination: { lat: destinationLat, lng: destinationLng, place_id: destinationPlaceId || null },
      interests
    };

    const res = await fetch(`${API_BASE}/places/alternatives`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok){
      const txt = await res.text().catch(() => "");
      throw new Error(txt || `HTTP ${res.status}`);
    }

    const alt = await res.json();
    return alt;
  }

  function renderRecCards(mood, items){
    const grid = document.getElementById("recGrid");
    const hint = document.getElementById("recHint");
    if (!grid) return;

    grid.innerHTML = "";
    selectedRec = null;
    selectedRecs = [];

    const tagMap = {
      hiking: "Hike",
      scenic: "Scenic",
      food: "Food",
      photo: "Photo",
      culture: "Culture",
      adventure: "Adventure",
      relax: "Relax"
    };

    if (hint) hint.textContent = "Choose one or more optional stops (first added becomes B)";

    items.forEach((it, idx) => {
      const title = it.title || it.name || `Suggested stop ${idx + 1}`;
      const detour = it.detour || it.detour_text || "+10 mins detour";
      const stay = it.stay || it.stay_text || "1 hr stop";
      const tag = it.tag || tagMap[mood] || "Recommended";

      const card = document.createElement("div");
      card.className = "recCard";
      card.innerHTML = `
        <div class="recTop">
          <div class="recName">${esc(title)}</div>
          <div class="recTag">${esc(tag)}</div>
        </div>
        <div class="recImgs">
          <div class="recImg" aria-hidden="true"></div>
          <div class="recImg" aria-hidden="true"></div>
        </div>
        <div class="recDesc">${esc(it.description || "A great stop to match your mood.")}</div>
        <div class="recMetaRow">
          <div class="recMeta">‚≠ê ${esc(stay)} ‚Ä¢ ${esc(detour)}</div>
          <button type="button" class="recBtn" data-idx="${idx}">Add stop</button>
        </div>
      `;

      const btn = card.querySelector(".recBtn");
      if (btn){
        btn.addEventListener("click", () => {
          const id = it.place_id || it.title || `idx-${idx}`;

          if (btn.classList.contains("added")) {
            // unselect this card
            btn.classList.remove("added");
            btn.textContent = "Add stop";
            selectedRecs = selectedRecs.filter(r => (r.place_id || r.title || "") !== (it.place_id || it.title || ""));
          } else {
            // select this card
            btn.classList.add("added");
            btn.textContent = "‚úì Added";
            selectedRecs.push(it);
          }

          // keep the first selected one as the primary B stop for Stage 4
          selectedRec = selectedRecs[0] || null;
        });
      }

      grid.appendChild(card);
    });
  }

  async function loadRecommendations(mood){
    const grid = document.getElementById("recGrid");
    const hint = document.getElementById("recHint");
    if (grid) grid.innerHTML = "";

    // Guard: we need real lat/lng to ask backend for real-time places
    if (startLat == null || startLng == null || destinationLat == null || destinationLng == null){
      if (hint) hint.textContent = "Pick Start & Destination from suggestions first (so we have lat/lng). Showing placeholders for now.";
      const placeholders = [
        { title: "Oakwood Nature Trail", tag: "Nature", description: "Relaxing stop with easy trails.", stay: "1 hr stop", detour: "+10 mins detour" },
        { title: "Pine Ridge Clifftop Hike", tag: "Hike", description: "Great views and a photo moment.", stay: "2 hr stop", detour: "+15 mins detour" },
        { title: "Cedar Falls Trail", tag: "Nature", description: "Scenic stop with water views.", stay: "1.5 hr stop", detour: "+12 mins detour" },
        { title: "Sunset Hill Lookout", tag: "Hidden Gem", description: "Perfect for a sunset break.", stay: "1 hr stop", detour: "+5 mins detour" }
      ];
      renderRecCards(mood, placeholders);
      return;
    }

    if (hint) hint.textContent = "Loading real-time recommendations‚Ä¶";

    // Real-time route-aware recommendations from backend
    try{
      const res = await fetch(`${API_BASE}/places/things-to-do`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          start: { lat: startLat, lng: startLng, place_id: startPlaceId || null },
          destination: { lat: destinationLat, lng: destinationLng, place_id: destinationPlaceId || null },
          mood,
          limit: 12
        })
      });

      if (!res.ok){
        const txt = await res.text().catch(() => "");
        if (hint) hint.textContent = `Backend error: ${res.status}`;
        throw new Error(txt || `HTTP ${res.status}`);
      }

      const data = await res.json();
      const items = [
  ...(data.en_route || []),
  ...(data.near_destination || [])
];

      const tagMap = {
        hiking: "Hike",
        scenic: "Scenic",
        food: "Food",
        photo: "Photo",
        culture: "Culture",
        adventure: "Adventure",
        relax: "Relax"
      };

      const mapped = items.map(p => ({
        title: p.title,
        place_id: p.place_id,
        lat: p.lat,
        lng: p.lng,
        tag: tagMap[mood] || "Recommended",
        description: p.formatted_address || "",
        stay: "1 hr stop",
        detour: "Along your route"
      }));

      if (hint) hint.textContent = `Showing ${mapped.length} real-time recommendations`;
      renderRecCards(mood, mapped);
      return;
    }catch(e){
      console.warn("/places/things-to-do failed, using placeholders:", e);
    }

    // Placeholders (fallback)
    const placeholders = [
      { title: "Oakwood Nature Trail", tag: "Nature", description: "Relaxing stop with easy trails.", stay: "1 hr stop", detour: "+10 mins detour" },
      { title: "Pine Ridge Clifftop Hike", tag: "Hike", description: "Great views and a photo moment.", stay: "2 hr stop", detour: "+15 mins detour" },
      { title: "Cedar Falls Trail", tag: "Nature", description: "Scenic stop with water views.", stay: "1.5 hr stop", detour: "+12 mins detour" },
      { title: "Sunset Hill Lookout", tag: "Hidden Gem", description: "Perfect for a sunset break.", stay: "1 hr stop", detour: "+5 mins detour" }
    ];

    renderRecCards(mood, placeholders);
  }

  // Scroll button behavior
  const scrollBtn = document.getElementById("scrollRecs");
  if (scrollBtn){
    scrollBtn.addEventListener("click", () => {
      const sc = document.getElementById("recScroll");
      if (!sc) return;
      sc.scrollBy({ top: Math.max(320, sc.clientHeight * 0.75), behavior: "smooth" });
    });
  }

  // Mood click wiring
  const moodList = document.getElementById("moodList");
  if (moodList){
    moodList.addEventListener("click", (e) => {
      const btn = e.target.closest(".moodBtn");
      if (!btn) return;
      const mood = btn.dataset.mood;
      setMoodActive(mood);
      loadRecommendations(mood);
    });
  }

  // Stage 3.5 actions
  const backToStage3Btn = document.getElementById("backToStage3");
  if (backToStage3Btn){
    backToStage3Btn.addEventListener("click", () => {
      shell.classList.remove("stage2", "stage35", "stage4");
      shell.classList.add("stage3");
      stage2Panel.setAttribute("aria-hidden", "true");
      stage3Panel.setAttribute("aria-hidden", "false");
      stage35Panel.setAttribute("aria-hidden", "true");
      stage4Panel.setAttribute("aria-hidden", "true");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }

  const backToStage35From4 = document.getElementById("backToStage35From4");
if (backToStage35From4) {
  backToStage35From4.addEventListener("click", () => {
    openStage35();
  });
}

const continueToStage4Btn = document.getElementById("continueToStage4");
if (continueToStage4Btn){
  continueToStage4Btn.addEventListener("click", async () => {
    // IMPORTANT: If start/dest aren't resolved yet, do NOT allow placeholder routing
    if (startLat == null || startLng == null || destinationLat == null || destinationLng == null){
      alert("Please pick Start & Destination from the suggestions first (so we have lat/lng).");
      return;
    }

    // Resolve coords for selected stops (if any missing)
    let midStops = getMidStops();
    midStops = await ensureStopsHaveCoords(midStops);

    const resolved = midStops.filter(s => typeof s.lat === "number" && typeof s.lng === "number");
    const dropped  = midStops.filter(s => !(typeof s.lat === "number" && typeof s.lng === "number"));

    // If any selected stops couldn't be resolved, remove them from selection so UI matches map
    if (dropped.length){
      alert(
        "Some selected stops could not be found on Google Maps and were skipped:\n\n- " +
        dropped.map(s => s.title).join("\n- ")
      );

      // keep only resolved
      selectedRecs = (selectedRecs || []).filter(r => {
        const title = r.title || r.name || "";
        return resolved.some(s => s.title === title);
      });
      selectedRec = selectedRecs[0] || null;
    }

    // Optional backend save
    const base = Object.assign({}, stage35BasePayload || {});
    base.mid_stops = resolved.map(s => ({ title: s.title, lat: s.lat, lng: s.lng }));

    try{
      await fetch(`${API_BASE}/plan-trip`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(base)
      });
    }catch(e){
      console.warn("/plan-trip call failed:", e);
    }

    openStage4();
    renderItinerary();
    await updateStage4Route();
    await updateLegTimes();   // ‚úÖ fill the right side ‚Äúüöó ‚Ä¶‚Äù rows
  });
}


  // ----------------------------
// Dynamic stops list (A, B, C, D...)
// ----------------------------
const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

function stopKey(it){
  const pid = it?.place_id;
  const title = (it?.title || it?.name || "").trim().toLowerCase();
  return pid ? `pid:${pid}` : `t:${title}`;
}

function getMidStops(){
  return (selectedRecs || []).map(r => ({
    title: r.title || r.name || "Stop",
    place_id: r.place_id || null,
    lat: (typeof r.lat === "number") ? r.lat : null,
    lng: (typeof r.lng === "number") ? r.lng : null,
    stay: r.stay || "1 hr"
  }));
}

function getResolvedMidStops(){
  return getMidStops().filter(s => typeof s.lat === "number" && typeof s.lng === "number");
}

async function ensureStopsHaveCoords(midStops){
  for (const s of midStops){
    if (typeof s.lat === "number" && typeof s.lng === "number") continue;
    try{
      const res = await fetch(`${API_BASE}/places/resolve`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: s.title })
      });
      if (!res.ok) continue;
      const data = await res.json();
      const p = data.place || data || {};
      if (typeof p.lat === "number" && typeof p.lng === "number"){
        s.lat = p.lat;
        s.lng = p.lng;
        s.place_id = s.place_id || p.place_id || null;
      }
    }catch(e){
      console.warn("resolve stop failed", s.title, e);
    }
  }
  return midStops;
}

function renderItinerary(){
  const listEl = document.getElementById("itinList");
  if (!listEl) return;

  const startTitle = startEl.value.trim() || "Start";
  const destTitle  = destEl.value.trim()  || "Destination";

  const mids = getMidStops();
  const stops = [
    { title: startTitle, fixed: true, kind: "start" },
    ...mids.map(s => ({ ...s, fixed: false, kind: "mid" })),
    { title: destTitle, fixed: true, kind: "dest" }
  ];

  listEl.innerHTML = "";

  stops.forEach((s, idx) => {
    const letter = LETTERS[idx] || "?";
    const isStart = (s.kind === "start");
    const isDest  = (s.kind === "dest");
    const badgeBg = isStart ? "var(--brandA)" : (isDest ? "#22c55e" : "#f59e0b");

    const row = document.createElement("div");
    row.className = "stopRow";
    row.innerHTML = `
      <div class="stopLeft">
        <div class="stopBadge" style="background:${badgeBg}">${esc(letter)}</div>
        <div style="min-width:0;">
          <div class="stopText">${esc(s.title)}</div>
          ${(!isStart && !isDest) ? `<div style="margin-top:6px; color: rgba(11,18,32,.65); font-weight:800;">‚è± ${esc(s.stay || "1 hr")}</div>` : ""}
        </div>
      </div>
      <div class="stopActions">
        <span title="Drag handle">‚â°</span>
        ${(!s.fixed) ? `<button type="button" class="delStop" data-k="${esc(stopKey(s))}" style="border:0;background:transparent;cursor:pointer;font-size:16px;">üóë</button>` : ""}
      </div>
    `;
    listEl.appendChild(row);

    if (idx < stops.length - 1){
  const t = document.createElement("div");
  t.className = "timeRow";
  t.setAttribute("data-leg", String(idx));      // <-- important
  t.textContent = "üöó calculating‚Ä¶";
  listEl.appendChild(t);
}
  });

  listEl.querySelectorAll(".delStop").forEach(btn => {
    btn.addEventListener("click", async () => {
      const k = btn.getAttribute("data-k") || "";

      // Remove the stop from the selected recommendations
      selectedRecs = (selectedRecs || []).filter(r => stopKey(r) !== k);
      selectedRec = selectedRecs[0] || null;

      // Re-render UI + recompute route
      renderItinerary();
      await updateStage4Route();
      await updateLegTimes();
    });
  });
}

  // --- Stage 4: Google Map state ---
let gMap = null;
let gPolyline = null;
let gMarkers = [];



function clearMapOverlays(){
  if (gPolyline){ gPolyline.setMap(null); gPolyline = null; }
  gMarkers.forEach(m => { try{ m.setMap(null); }catch(_){ } });
  gMarkers = [];
}

function ensureMapReady(){
  const canvas = document.getElementById("mapCanvas");
  const mock = document.getElementById("mockRouteLine");

  if (!window.google || !google.maps || !canvas) {
    if (mock) mock.style.display = "block";
    return false;
  }

  if (!gMap){
    gMap = new google.maps.Map(canvas, {
      center: { lat: 39.5, lng: -98.35 },
      zoom: 4,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
    });
  }

  if (mock) mock.style.display = "none";
  return true;
}

window.onGoogleMapsLoaded = function () {
  ensureMapReady();

  if (shell.classList.contains("stage4")) {
    (async () => {
      await updateStage4Route();
      await updateLegTimes();
    })();
  }
};
// Decode encoded polyline (Google encoded polyline algorithm)
function decodePolyline(encoded){
  let index = 0, lat = 0, lng = 0;
  const coordinates = [];

  while (index < encoded.length){
    let b, shift = 0, result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lat += dlat;

    shift = 0;
    result = 0;
    do {
      b = encoded.charCodeAt(index++) - 63;
      result |= (b & 0x1f) << shift;
      shift += 5;
    } while (b >= 0x20);
    const dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
    lng += dlng;

    coordinates.push({ lat: lat / 1e5, lng: lng / 1e5 });
  }

  return coordinates;
}

async function fetchRouteFromBackend(payload, opts = {}){
  const timeoutMs = typeof opts.timeoutMs === "number" ? opts.timeoutMs : 15000;
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), timeoutMs);

  try{
    const res = await fetch(`${API_BASE}/routes`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    if (!res.ok){
      const txt = await res.text().catch(() => "");
      throw new Error(txt || `HTTP ${res.status}`);
    }

    return await res.json();
  }catch(e){
    // If backend or Google call hangs, avoid leaving UI stuck on ‚Äúcalculating‚Ä¶‚Äù
    if (e && (e.name === "AbortError" || String(e).includes("AbortError"))){
      throw new Error("Route request timed out");
    }
    throw e;
  }finally{
    clearTimeout(timer);
  }
}

function getRoutePointsForLegs(){
  const mids = getResolvedMidStops();
  return [
    { lat: startLat, lng: startLng, place_id: startPlaceId || null },
    ...mids.map(s => ({ lat: s.lat, lng: s.lng, place_id: s.place_id || null })),
    { lat: destinationLat, lng: destinationLng, place_id: destinationPlaceId || null }
  ];
}


 

function renderRouteOnMap(route){
  if (!ensureMapReady()) return;
  clearMapOverlays();

  const path = route?.polyline ? decodePolyline(route.polyline) : null;
  if (!path || path.length < 2){
    console.warn("No polyline to draw:", route);
    return;
  }

  gPolyline = new google.maps.Polyline({
    path,
    geodesic: true,
    strokeOpacity: 0.9,
    strokeWeight: 6,
    map: gMap,
  });

  const a = path[0];
  const dest = path[path.length - 1];
  gMarkers.push(new google.maps.Marker({ position: a, map: gMap, label: "A" }));

  const mids = getResolvedMidStops();
  mids.forEach((s, i) => {
    const letter = LETTERS[i + 1] || "?";
    gMarkers.push(new google.maps.Marker({ position: { lat: s.lat, lng: s.lng }, map: gMap, label: letter }));
  });

  const destLetter = LETTERS[mids.length + 1] || "?";
  gMarkers.push(new google.maps.Marker({ position: dest, map: gMap, label: destLetter }));

  const bounds = new google.maps.LatLngBounds();
  path.forEach(p => bounds.extend(p));
  mids.forEach(s => bounds.extend({ lat: s.lat, lng: s.lng }));
  gMap.fitBounds(bounds);
}

function renderExtraStops(){
  const wrap = document.getElementById("extraStopsWrap");
  const list = document.getElementById("extraStopsList");
  if (!wrap || !list) return;

  const extras = (selectedRecs || []).filter(r => r !== selectedRec);
  list.innerHTML = "";
  if (!extras.length){
    wrap.style.display = "none";
    return;
  }

  extras.forEach((it, idx) => {
    const title = it.title || it.name || `Stop ${idx + 2}`;
    const stay = it.stay || "1 hr stop";
    const div = document.createElement("div");
    div.className = "extraStop";
    div.textContent = `${title} ‚Ä¢ ${stay}`;
    list.appendChild(div);
  });

  wrap.style.display = "block";
}

async function updateStage4Route(){
  if (startLat == null || startLng == null || destinationLat == null || destinationLng == null){
    console.warn("Missing lat/lng for route", { startLat, startLng, destinationLat, destinationLng });
    return;
  }

  const payload = {
    start: { lat: startLat, lng: startLng, place_id: startPlaceId || null },
    destination: { lat: destinationLat, lng: destinationLng, place_id: destinationPlaceId || null },
  };

  // Multi-stop waypoints (B, C, D...)
  const mids = getResolvedMidStops();
  if (mids.length){
    payload.waypoints = mids.map(s => ({ lat: s.lat, lng: s.lng, place_id: s.place_id || null }));
  }

  try{
    const route = await fetchRouteFromBackend(payload);
    lastStage4Route = route;
    renderRouteOnMap(route);

    const dur = route.duration_text || route.duration || null;
    const dist = route.distance_text || route.distance || null;

    const pill = document.getElementById("mapPillText");
    if (pill){
      pill.textContent = dist && dur ? `${dist} ‚Ä¢ ${dur}` : (dur || "Route preview");
    }

    renderExtraStops();
    return route;
    

  }catch(e){
    console.warn("/routes not ready yet:", e);
    const mock = document.getElementById("mockRouteLine");
    if (mock) mock.style.display = "block";
    return null;
  }
}

// Use the single Stage 4 /routes response (with legs[]) to fill the right-side times
async function updateLegTimes(){
  const listEl = document.getElementById("itinList");
  if (!listEl) return;

  const rows = Array.from(listEl.querySelectorAll('.timeRow[data-leg]'));
  if (!rows.length) return;

  const legs = (lastStage4Route && Array.isArray(lastStage4Route.legs)) ? lastStage4Route.legs : [];

  if (!legs.length){
    // Backend didn't return legs[] (or server wasn't restarted)
    rows.forEach(r => {
      if (String(r.textContent || "").includes("calculating")) r.textContent = "üöó unavailable (no legs data)";
    });
    return;
  }

  rows.forEach((row) => {
    const idx = Number(row.getAttribute('data-leg'));
    const leg = Number.isFinite(idx) ? legs[idx] : null;

    if (!leg){
      row.textContent = "";
      return;
    }

    const dist = leg.distance_text || "";
    const dur  = leg.duration_text || "";

    if (dist && dur) row.textContent = `üöó ${dist} ‚Ä¢ ${dur}`;
    else if (dur) row.textContent = `üöó ${dur}`;
    else if (dist) row.textContent = `üöó ${dist}`;
    else row.textContent = "üöó unavailable";
  });
}
  // --- Autocomplete state ---
const startAcList = document.getElementById("startAcList");
const destAcList  = document.getElementById("destAcList");

let startSelected = null; // { description, place_id, types }
let destSelected  = null; // { description, place_id, types }

function showList(listEl, items, onPick){
  listEl.innerHTML = "";
  if (!items || items.length === 0){
    listEl.classList.remove("show");
    return;
  }
  items.slice(0, 8).forEach((p) => {
    const div = document.createElement("div");
    div.className = "acItem";
    div.textContent = p.description || "";
    div.addEventListener("mousedown", (e) => {
      e.preventDefault(); // so blur doesn't kill click
      onPick(p);
    });
    listEl.appendChild(div);
  });
  listEl.classList.add("show");
}

function hideList(listEl){
  listEl.classList.remove("show");
}

async function fetchAutocomplete(query){
  // We want "recommendations" without using the Google Places JS Autocomplete widget.
  // So we call our backend and render the custom dropdown.

  // 1) Try GET with `input=` (current)
  const getUrl1 = `http://127.0.0.1:8000/places/autocomplete?input=${encodeURIComponent(query)}&components=country:us`;
  try{
    const res = await fetch(getUrl1, { method: "GET" });
    if (res.ok) return await res.json();
    const txt = await res.text().catch(() => "");
    console.warn("Autocomplete GET (input=) failed", res.status, txt);
  }catch(e){
    console.warn("Autocomplete GET (input=) network error:", e);
  }

  // 2) Try GET with `text=` (some backends name it this way)
  const getUrl2 = `http://127.0.0.1:8000/places/autocomplete?text=${encodeURIComponent(query)}&components=country:us`;
  try{
    const res = await fetch(getUrl2, { method: "GET" });
    if (res.ok) return await res.json();
    const txt = await res.text().catch(() => "");
    console.warn("Autocomplete GET (text=) failed", res.status, txt);
  }catch(e){
    console.warn("Autocomplete GET (text=) network error:", e);
  }

  // 3) Try POST (send BOTH `input` and `text` for maximum compatibility)
  try{
    const res = await fetch("http://127.0.0.1:8000/places/autocomplete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ input: query, text: query, components: "country:us" })
    });
    if (res.ok) return await res.json();
    const txt = await res.text().catch(() => "");
    console.warn("Autocomplete POST failed", res.status, txt);
  }catch(e){
    console.warn("Autocomplete POST network error:", e);
  }

  // 4) Last resort: fall back to /places/resolve and convert to a single-item "predictions" array.
  // This gives *some* recommendation behavior even if autocomplete endpoint is missing.
  try{
    const res = await fetch("http://127.0.0.1:8000/places/resolve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: query })
    });
    if (!res.ok){
      const txt = await res.text().catch(() => "");
      throw new Error(`Resolve fallback failed ${res.status}: ${txt}`);
    }
    const data = await res.json();
    const place = data.place || {};
    if (place.place_id){
      return {
        predictions: [{
          description: place.formatted_address || place.name || query,
          place_id: place.place_id
        }]
      };
    }
  }catch(e){
    console.warn("Autocomplete fallback via /places/resolve failed:", e);
  }

  // Nothing worked
  return { predictions: [] };
}

async function fetchDetails(placeId){
  const getUrl = `http://127.0.0.1:8000/places/details?place_id=${encodeURIComponent(placeId)}`;
  try{
    const res = await fetch(getUrl, { method: "GET" });
    if (res.ok) return await res.json();

    let errTxt = "";
    try{ errTxt = await res.text(); }catch(_){ }
    console.warn("Details GET failed", res.status, errTxt);
  }catch(e){
    console.warn("Details GET network error:", e);
  }

  const postUrl = "http://127.0.0.1:8000/places/details";
  const res2 = await fetch(postUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ place_id: placeId })
  });
  if (!res2.ok){
    const txt = await res2.text().catch(() => "");
    throw new Error(`Details failed. ${res2.status}. ${txt}`);
  }
  return await res2.json();
}
function wireAutocomplete(inputEl, listEl, onPicked){
  let t = null;

  inputEl.addEventListener("input", () => {
    clearTimeout(t);
    const q = inputEl.value.trim();

    // typing invalidates previous selection
    onPicked(null, true);

    if (q.length < 2){
      hideList(listEl);
      return;
    }

    const thisQuery = q; // capture query for this run

    t = setTimeout(async () => {
      try{
        const data = await fetchAutocomplete(thisQuery);

        // Ignore stale responses (if user typed something new in the meantime)
        if (inputEl.value.trim() !== thisQuery) {
          return;
        }

        showList(listEl, data.predictions || [], (pred) => {
          inputEl.value = pred.description || inputEl.value;
          hideList(listEl);
          onPicked(pred, false);
        });
      }catch(e){
        hideList(listEl);
        console.warn("Autocomplete error:", e);
        const hintId = (inputEl.id === "start") ? "startHint" : (inputEl.id === "dest") ? "destHint" : null;
        const hintEl = hintId ? document.getElementById(hintId) : null;
        if (hintEl){
          hintEl.textContent = "Autocomplete not available (check backend /places/autocomplete)";
          setTimeout(() => { hintEl.textContent = "Pick a suggestion for best results"; }, 2500);
        }
      }
    }, 250);
  });

  inputEl.addEventListener("focus", () => {
    const q = inputEl.value.trim();
    if (q.length >= 2) inputEl.dispatchEvent(new Event("input"));
  });

  inputEl.addEventListener("blur", () => {
    setTimeout(() => hideList(listEl), 120);
  });
}

// Wire autocomplete for Start & Destination (Stage 1)
wireAutocomplete(startEl, startAcList, async (pred, typed) => {
  if (typed) {
    startSelected = null;
    startPlaceId = startLat = startLng = null;
    return;
  }
  startSelected = pred;
  startPlaceId = pred?.place_id || null;
  startLat = startLng = null;

  if (startPlaceId){
    try{
      const d = await fetchDetails(startPlaceId);
      startLat = (typeof d.lat === "number") ? d.lat : null;
      startLng = (typeof d.lng === "number") ? d.lng : null;
    }catch(e){
      console.warn("Start details error:", e);
    }
  }
});

wireAutocomplete(destEl, destAcList, async (pred, typed) => {
  if (typed) {
    destSelected = null;
    destinationPlaceId = destinationLat = destinationLng = null;
    return;
  }
  destSelected = pred;
  destinationPlaceId = pred?.place_id || null;
  destinationLat = destinationLng = null;

  if (destinationPlaceId){
    try{
      const d = await fetchDetails(destinationPlaceId);
      destinationLat = (typeof d.lat === "number") ? d.lat : null;
      destinationLng = (typeof d.lng === "number") ? d.lng : null;
    }catch(e){
      console.warn("Destination details error:", e);
    }
  }

  // update palette as soon as user picks a destination
  updateThemeFromDestination();
});

  // ----------------------------
  // Google Places (Option A): resolve destination via backend (key stays on server)
  // ----------------------------
  let destinationPlaceId = null;
  let destinationLat = null;
  let destinationLng = null;

  let startPlaceId = null;
  let startLat = null;
  let startLng = null;

  async function resolveDestinationViaBackend() {
    const destinationText = destEl.value.trim();
    if (!destinationText) {
      alert("Please enter a destination.");
      destEl.focus();
      return false;
    }

    try {
      const res = await fetch("http://127.0.0.1:8000/places/resolve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: destinationText })
      });

      if (!res.ok) {
        let msg = `Places resolve failed (HTTP ${res.status})`;
        try {
          const err = await res.json();
          if (err && err.detail) msg = String(err.detail);
        } catch (_) {}
        alert(msg);
        return false;
      }

      const data = await res.json();
      const place = data.place || {};
      destinationPlaceId = place.place_id || null;
      destinationLat = (typeof place.lat === "number") ? place.lat : null;
      destinationLng = (typeof place.lng === "number") ? place.lng : null;

      console.log("‚úÖ Destination resolved via backend:", data);
      return true;
    } catch (e) {
      alert("Backend error while resolving destination: " + (e?.message || e));
      return false;
    }
  }

  async function resolveStartViaBackend() {
    const startText = startEl.value.trim();
    if (!startText) {
      alert("Please enter a start location.");
      startEl.focus();
      return false;
    }

    try {
      const res = await fetch("http://127.0.0.1:8000/places/resolve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: startText })
      });

      if (!res.ok) {
        let msg = `Start resolve failed (HTTP ${res.status})`;
        try {
          const err = await res.json();
          if (err && err.detail) msg = String(err.detail);
        } catch (_) {}
        alert(msg);
        return false;
      }

      const data = await res.json();
      const place = data.place || {};
      startPlaceId = place.place_id || null;
      startLat = (typeof place.lat === "number") ? place.lat : null;
      startLng = (typeof place.lng === "number") ? place.lng : null;
      console.log("‚úÖ Start resolved via backend:", data);
      return true;
    } catch (e) {
      alert("Backend error while resolving start: " + (e?.message || e));
      return false;
    }
  }

  // Always start Stage 1
  shell.classList.remove("stage2","stage3","stage4","stage35");
  stage2Panel.setAttribute("aria-hidden", "true");
  stage3Panel.setAttribute("aria-hidden", "true");
  stage35Panel.setAttribute("aria-hidden", "true");
  stage4Panel.setAttribute("aria-hidden", "true");

  // ----------------------------
  // Theme from destination state (palette.js)
  // ----------------------------
  const STATE_ABBR = {
    AL:"Alabama", AK:"Alaska", AZ:"Arizona", AR:"Arkansas", CA:"California", CO:"Colorado", CT:"Connecticut",
    DE:"Delaware", FL:"Florida", GA:"Georgia", HI:"Hawaii", ID:"Idaho", IL:"Illinois", IN:"Indiana", IA:"Iowa",
    KS:"Kansas", KY:"Kentucky", LA:"Louisiana", ME:"Maine", MD:"Maryland", MA:"Massachusetts", MI:"Michigan",
    MN:"Minnesota", MS:"Mississippi", MO:"Missouri", MT:"Montana", NE:"Nebraska", NV:"Nevada", NH:"New Hampshire",
    NJ:"New Jersey", NM:"New Mexico", NY:"New York", NC:"North Carolina", ND:"North Dakota", OH:"Ohio", OK:"Oklahoma",
    OR:"Oregon", PA:"Pennsylvania", RI:"Rhode Island", SC:"South Carolina", SD:"South Dakota", TN:"Tennessee",
    TX:"Texas", UT:"Utah", VT:"Vermont", VA:"Virginia", WA:"Washington", WV:"West Virginia", WI:"Wisconsin", WY:"Wyoming"
  };

  function normalizeStateFromLocation(input) {
    const raw = (input || "").trim();
    if (!raw) return null;

    const parts = raw.split(",").map(s => s.trim()).filter(Boolean);
    const last = (parts[parts.length - 1] || "").trim();
    if (!last) return null;

    const abbr = last.toUpperCase();
    if (STATE_ABBR[abbr]) return STATE_ABBR[abbr];

    try {
      const keys = (typeof STATE_THEMES !== "undefined" && STATE_THEMES) ? Object.keys(STATE_THEMES) : [];
      const match = keys.find(k => k.toLowerCase() === last.toLowerCase());
      return match || null;
    } catch {
      return null;
    }
  }

  function updateThemeFromDestination() {
    const stateName = normalizeStateFromLocation(destEl.value);
    if (stateName && typeof applyStateTheme === "function") {
      applyStateTheme(stateName);
    }
  }

  // Live destination typing (debounced)
  destEl.addEventListener("input", () => {
    clearTimeout(window.__themeT);
    window.__themeT = setTimeout(updateThemeFromDestination, 200);
  });

  // --- Stage 1 -> Stage 2 ---
  document.getElementById("continueBtn").addEventListener("click", async () => {
    const start = startEl.value.trim();
    const dest = destEl.value.trim();

    if (!start || !dest) {
      alert("Please enter both Start and Destination.");
      if (!start) startEl.focus();
      else destEl.focus();
      return;
    }

    // Resolve start + destination with Google Places via backend (Option A)
    // If the user picked an autocomplete suggestion, we already have place_id (and usually lat/lng).
    // Only fall back to /places/resolve when missing.

    let okStart = true;
    if (!startPlaceId || startLat == null || startLng == null) {
      okStart = await resolveStartViaBackend();
    }
    if (!okStart) return;

    let okDest = true;
    if (!destinationPlaceId || destinationLat == null || destinationLng == null) {
      okDest = await resolveDestinationViaBackend();
    }
    if (!okDest) return;

    console.log("Start:", { startPlaceId, startLat, startLng, startText: startEl.value.trim() });
    console.log("Destination:", { destinationPlaceId, destinationLat, destinationLng, destText: destEl.value.trim() });
    updateThemeFromDestination();
    hideList(startAcList);
    hideList(destAcList);

    shell.classList.add("stage2");
    stage2Panel.setAttribute("aria-hidden", "false");
    stage35Panel.setAttribute("aria-hidden", "true");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // --- Stage 2 -> Stage 3 ---
  document.getElementById("nextBtn").addEventListener("click", () => {
    updateThemeFromDestination();

    // group pill
    document.getElementById("groupPill").textContent =
      `Adults ${+adultsEl.textContent}, Kids ${+kidsEl.textContent}`;

    // selected preferences summary
    const selectedPrefsEl = document.getElementById("selectedPrefs");
    selectedPrefsEl.innerHTML = "";
    const selected = Array.from(document.querySelectorAll("#chips .chip.on"));
    selected.forEach(chip => selectedPrefsEl.appendChild(chip.cloneNode(true)));

    // collapse prefs list by default
    const prefToggle = document.getElementById("prefToggle");
    selectedPrefsEl.classList.remove("expanded");
    prefToggle.textContent = "Show all";
    prefToggle.setAttribute("aria-expanded", "false");
    prefToggle.style.display = (selected.length > 6) ? "inline-flex" : "none";

    shell.classList.remove("stage2");
    shell.classList.remove("stage35");
    shell.classList.add("stage3");
    stage2Panel.setAttribute("aria-hidden", "true");
    stage3Panel.setAttribute("aria-hidden", "false");
    stage35Panel.setAttribute("aria-hidden", "true");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // Stage 3 preferences: expand/collapse
  document.getElementById("prefToggle").addEventListener("click", () => {
    const list = document.getElementById("selectedPrefs");
    const toggle = document.getElementById("prefToggle");
    const expanded = list.classList.toggle("expanded");
    toggle.textContent = expanded ? "Show less" : "Show all";
    toggle.setAttribute("aria-expanded", expanded ? "true" : "false");
  });

  // Segmented switch behavior (Stage 3 constraints)
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".seg button");
    if (!btn) return;

    const seg = btn.parentElement;
    seg.querySelectorAll("button").forEach(b => b.classList.remove("on"));
    btn.classList.add("on");
  });

// --- Stage 3 -> Stage 3.5 (Build itinerary) ---
document.getElementById("buildBtn").addEventListener("click", async () => {
  // 1) constraints
  const constraints = {};
  document.querySelectorAll(".seg").forEach(seg => {
    const key = seg.dataset.key;
    const active = seg.querySelector("button.on");
    constraints[key] = active ? active.dataset.val : null;
  });

  // 2) interests from chips
  const interests = Array.from(document.querySelectorAll("#chips .chip.on")).map(c => {
    const k = c.dataset.key;
    if (k === "photo") return "photography";
    if (k === "hidden") return "hidden gems";
    return k;
  });

  // 3) build backend payload (saved for Stage 4)
  const backendPayload = {
    start_city: startEl.value.trim(),
    destination: destEl.value.trim(),
    destination_state: normalizeStateFromLocation(destEl.value) || "Texas",

    start_place_id: startPlaceId,
    start_lat: startLat,
    start_lng: startLng,

    destination_place_id: destinationPlaceId,
    destination_lat: destinationLat,
    destination_lng: destinationLng,

    days: +daysEl.textContent,
    pace: constraints.adventureLevel || "balanced",
    group: { adults: +adultsEl.textContent, kids: +kidsEl.textContent },
    interests
  };

  stage35BasePayload = backendPayload;
  stage35Constraints = constraints;
  stage35Interests = interests;

  // Stage 4 pill (itinerary list is rendered dynamically later)
  document.getElementById("mapPillText").textContent = `${backendPayload.start_city || "Start"} ‚Üí ${backendPayload.destination || "Destination"}`;

  // Open Stage 3.5 and load initial mood recommendations
  openStage35();
  setMoodActive("hiking");
  await loadRecommendations("hiking");
});





  // Stage 4 button placeholder (only if such a button exists)
  const optimizeBtn = document.getElementById("optimizeBtn");
  if (optimizeBtn){
    optimizeBtn.addEventListener("click", () => {
      alert("Optimize Trip ‚Üí coming next (real route + stop suggestions)");
    });
  }



  // Apply theme on load if destination already includes state
  updateThemeFromDestination();
</script>

</body>
</html>
